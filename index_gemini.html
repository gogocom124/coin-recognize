<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI ë™ì „ ë„ê° v5.0 (Fixed)</title>
    <script src="https://docs.opencv.org/4.5.0/opencv.js"></script>
    <style>
        /* ì‚¬ìš©ìë‹˜ì´ ë§Œë“œì‹  UI ìŠ¤íƒ€ì¼ ê·¸ëŒ€ë¡œ ìœ ì§€ */
        :root { --primary: #4285f4; --success: #34a853; --warning: #fbbc05; --error: #ea4335; --bg-dark: #1a1a2e; --card-bg: rgba(255, 255, 255, 0.95); }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Noto Sans KR', 'Segoe UI', sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; color: #333; }
        .container { max-width: 800px; margin: 0 auto; }
        header { background: rgba(0, 0, 0, 0.8); color: white; padding: 20px; border-radius: 15px; margin-bottom: 20px; text-align: center; backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.1); }
        header h1 { font-size: 1.8rem; display: flex; align-items: center; justify-content: center; gap: 10px; }
        .system-status { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 20px; }
        .status-card { background: rgba(0, 0, 0, 0.7); color: white; padding: 15px; border-radius: 10px; text-align: center; backdrop-filter: blur(5px); }
        .status-card .label { font-size: 12px; color: #aaa; margin-bottom: 5px; }
        .status-card .value { font-weight: bold; font-size: 14px; }
        .status-card .value.success { color: #34a853; }
        .status-card .value.warning { color: #fbbc05; }
        .status-card .value.error { color: #ea4335; }
        .camera-container { position: relative; width: 100%; max-width: 400px; margin: 0 auto 20px; border-radius: 15px; overflow: hidden; box-shadow: 0 10px 30px rgba(0,0,0,0.3); }
        video { width: 100%; height: 400px; object-fit: cover; display: block; background: #000; }
        .camera-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; }
        .guide-circle { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 200px; height: 200px; border: 3px dashed rgba(0, 255, 0, 0.7); border-radius: 50%; animation: pulse 2s infinite; }
        @keyframes pulse { 0% { border-color: rgba(0, 255, 0, 0.7); } 50% { border-color: rgba(0, 255, 0, 1); } 100% { border-color: rgba(0, 255, 0, 0.7); } }
        .controls { display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; margin-bottom: 25px; }
        button { padding: 15px 20px; border: none; border-radius: 10px; font-weight: 600; font-size: 16px; cursor: pointer; transition: all 0.3s ease; display: flex; align-items: center; justify-content: center; gap: 8px; min-width: 150px; background: var(--card-bg); color: #333; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        button:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(0,0,0,0.2); }
        button:active:not(:disabled) { transform: translateY(0); }
        button:disabled { opacity: 0.5; cursor: not-allowed; }
        #scan-btn { background: linear-gradient(135deg, var(--primary), var(--success)); color: white; flex: 2; font-size: 18px; }
        .debug-panel { background: rgba(0, 0, 0, 0.8); color: white; border-radius: 10px; padding: 20px; margin-bottom: 20px; font-family: 'Courier New', monospace; font-size: 13px; max-height: 200px; overflow-y: auto; }
        .debug-log { margin-bottom: 5px; line-height: 1.4; }
        .debug-log.info { color: #34a853; }
        .debug-log.warn { color: #fbbc05; }
        .debug-log.error { color: #ea4335; }
        .debug-log.debug { color: #4285f4; }
        .coins-list { background: var(--card-bg); border-radius: 15px; padding: 25px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); margin-bottom: 30px; }
        .coins-list h2 { text-align: center; margin-bottom: 20px; color: #2c3e50; display: flex; align-items: center; justify-content: center; gap: 10px; }
        .coin-counter { background: var(--primary); color: white; padding: 2px 10px; border-radius: 20px; font-size: 14px; }
        table { width: 100%; border-collapse: collapse; }
        th { background: #f8f9fa; padding: 15px; color: #5a6c7d; font-weight: 600; text-align: center; border-bottom: 2px solid #dee2e6; }
        td { padding: 15px; border-bottom: 1px solid #eee; text-align: center; vertical-align: middle; }
        .coin-image { width: 60px; height: 60px; border-radius: 50%; object-fit: cover; border: 3px solid var(--primary); box-shadow: 0 4px 10px rgba(66, 133, 244, 0.3); }
        .empty-state { text-align: center; padding: 40px 20px; color: #7f8c8d; font-style: italic; }
        .ai-mode-badge { display: inline-block; padding: 3px 8px; border-radius: 4px; font-size: 12px; font-weight: bold; margin-left: 8px; }
        .ai-mode-badge.on { background: var(--success); color: white; }
        .ai-mode-badge.off { background: var(--error); color: white; }
        .ai-mode-badge.basic { background: var(--warning); color: white; }
        footer { text-align: center; color: rgba(255, 255, 255, 0.7); font-size: 12px; padding: 20px; }
        @media (max-width: 600px) { .system-status { grid-template-columns: 1fr; } button { min-width: 120px; padding: 12px 15px; font-size: 14px; } header h1 { font-size: 1.5rem; } .camera-container { max-width: 100%; } video { height: 300px; } }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ğŸª™ AI ë™ì „ ë„ê° v5.0</h1>
        </header>
        
        <div class="system-status">
            <div class="status-card">
                <div class="label">OpenCV ìƒíƒœ</div>
                <div class="value loading" id="opencv-status">í™•ì¸ ì¤‘...</div>
            </div>
            <div class="status-card">
                <div class="label">MediaPipe ìƒíƒœ</div>
                <div class="value loading" id="mediapipe-status">í™•ì¸ ì¤‘...</div>
            </div>
            <div class="status-card">
                <div class="label">ì¹´ë©”ë¼ ìƒíƒœ</div>
                <div class="value loading" id="camera-status">í™•ì¸ ì¤‘...</div>
            </div>
        </div>
        
        <div class="camera-container">
            <video id="webcam" autoplay playsinline></video>
            <div class="camera-overlay">
                <div class="guide-circle"></div>
            </div>
        </div>
        
        <div class="controls">
            <button id="scan-btn" disabled>ğŸ“· ë™ì „ ìŠ¤ìº”</button>
            <button id="torch-btn" disabled>ğŸ”¦ ë¼ì´íŠ¸</button>
            <button id="macro-btn" disabled>ğŸ” ì ‘ì‚¬ëª¨ë“œ</button>
            <button id="reload-btn" style="background:#6c757d; color:white;">ğŸ”„ ì¬ì‹œì‘</button>
        </div>
        
        <div class="debug-panel" id="debug-panel">
            <div class="debug-log info">[ì‹œìŠ¤í…œ] AI ë™ì „ ë„ê° v5.0 ì‹œì‘ ì¤‘...</div>
        </div>
        
        <div class="coins-list">
            <h2>
                ğŸ“‚ ìˆ˜ì§‘ëœ ë™ì „
                <span class="coin-counter" id="coin-count">0</span>
                <span id="ai-mode-badge" class="ai-mode-badge off">AI ì´ˆê¸°í™” ì¤‘</span>
            </h2>
            <table>
                <thead>
                    <tr>
                        <th>ì´ë¯¸ì§€</th>
                        <th>ê¸ˆì•¡</th>
                        <th>ì—°ë„</th>
                        <th>ì‹œê°„</th>
                        <th>ëª¨ë“œ</th>
                    </tr>
                </thead>
                <tbody id="coin-list">
                    <tr>
                        <td colspan="5" class="empty-state">
                            ì•„ì§ ìˆ˜ì§‘ëœ ë™ì „ì´ ì—†ìŠµë‹ˆë‹¤.<br>
                            ì¹´ë©”ë¼ë¥¼ ë™ì „ì— ë§ì¶”ê³  [ë™ì „ ìŠ¤ìº”] ë²„íŠ¼ì„ ëˆ„ë¥´ì„¸ìš”.
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
        
        <footer>
            AI ë™ì „ ì¸ì‹ ì‹œìŠ¤í…œ v5.0 | MediaPipe Tasks Vision | ì¹´ë©”ë¼ ê¶Œí•œ í•„ìš”
        </footer>
    </div>

    <canvas id="temp-canvas" style="display:none;"></canvas>
    
    <script type="module">
        import { TextRecognizer, FilesetResolver } from "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.3/vision_bundle.mjs";

        // ========== ì „ì—­ ë³€ìˆ˜ (ëª¨ë“ˆ ë‚´ë¶€) ==========
        const video = document.getElementById('webcam');
        const debugPanel = document.getElementById('debug-panel');
        const scanBtn = document.getElementById('scan-btn');
        const torchBtn = document.getElementById('torch-btn');
        const macroBtn = document.getElementById('macro-btn');
        const reloadBtn = document.getElementById('reload-btn');
        const coinList = document.getElementById('coin-list');
        const coinCount = document.getElementById('coin-count');
        const aiModeBadge = document.getElementById('ai-mode-badge');
        
        // ìƒíƒœ í‘œì‹œ ìš”ì†Œ
        const opencvStatus = document.getElementById('opencv-status');
        const mediapipeStatus = document.getElementById('mediapipe-status');
        const cameraStatus = document.getElementById('camera-status');
        
        let textRecognizer = null;
        let db = null;
        let videoTrack = null;
        let isTorchOn = false;
        let isMacroOn = false;
        let isProcessing = false;
        
        // ========== ë¡œê¹… ì‹œìŠ¤í…œ ==========
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logElement = document.createElement('div');
            logElement.className = `debug-log ${type}`;
            logElement.textContent = `[${timestamp}] ${message}`;
            debugPanel.appendChild(logElement);
            debugPanel.scrollTop = debugPanel.scrollHeight;
            console.log(`[${type.toUpperCase()}] ${message}`);
        }
        
        function updateStatus(element, status, message) {
            element.textContent = message;
            element.className = 'value ' + status;
        }

        // ========== ë°ì´í„°ë² ì´ìŠ¤ (IndexedDB) ==========
        function initDatabase() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open('CoinCollection_v5_Fix', 1);
                
                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    if (db.objectStoreNames.contains('coins')) {
                        db.deleteObjectStore('coins');
                    }
                    const store = db.createObjectStore('coins', { keyPath: 'id', autoIncrement: true });
                };
                
                request.onsuccess = (event) => {
                    db = event.target.result;
                    log('âœ… ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° ì„±ê³µ', 'success');
                    loadCoins();
                    resolve();
                };
                
                request.onerror = (event) => {
                    log('âŒ DB ì˜¤ë¥˜ ë°œìƒ', 'error');
                    reject(event.target.error);
                };
            });
        }

        function loadCoins() {
            if (!db) return;
            const tx = db.transaction('coins', 'readonly');
            const store = tx.objectStore('coins');
            const request = store.getAll();
            
            request.onsuccess = (event) => {
                const coins = event.target.result || [];
                coins.sort((a, b) => new Date(b.time) - new Date(a.time));
                renderCoinList(coins);
                coinCount.textContent = coins.length;
            };
        }

        function renderCoinList(coins) {
            if (!coins || coins.length === 0) {
                coinList.innerHTML = `<tr><td colspan="5" class="empty-state">ì•„ì§ ìˆ˜ì§‘ëœ ë™ì „ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>`;
                return;
            }
            
            let html = '';
            coins.forEach(coin => {
                const date = new Date(coin.time);
                const dateStr = date.toLocaleDateString();
                const timeStr = date.toLocaleTimeString();
                
                html += `
                    <tr>
                        <td><img src="${URL.createObjectURL(coin.image)}" class="coin-image"></td>
                        <td style="font-weight:bold; font-size:18px;">${coin.amount}ì›</td>
                        <td style="font-weight:bold; font-size:18px; color:#ea4335;">${coin.year}ë…„</td>
                        <td style="font-size:12px; color:#666;">${dateStr}<br>${timeStr}</td>
                        <td><span style="color:#34a853; font-size:11px;">ğŸ¤– AI</span></td>
                    </tr>
                `;
            });
            coinList.innerHTML = html;
        }

        // ========== AI ëª¨ë¸ ì´ˆê¸°í™” (ëª¨ë“ˆ ë°©ì‹) ==========
        async function initAI() {
            try {
                log('AI ì—”ì§„ ë¡œë”© ì¤‘... (ëª¨ë“ˆ ë°©ì‹)', 'info');
                updateStatus(mediapipeStatus, 'loading', 'ë‹¤ìš´ë¡œë“œ ì¤‘...');

                const vision = await FilesetResolver.forVisionTasks(
                    "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.3/wasm"
                );
                
                textRecognizer = await TextRecognizer.createFromOptions(vision, {
                    baseOptions: {
                        modelAssetPath: "https://storage.googleapis.com/mediapipe-models/text_recognizer/text_recognizer_thin/float32/1/text_recognizer_thin.tflite",
                        delegate: "GPU"
                    },
                    runningMode: "IMAGE"
                });

                log('âœ… AI ì—”ì§„ ì¤€ë¹„ ì™„ë£Œ!', 'success');
                updateStatus(mediapipeStatus, 'success', 'ì •ìƒ ì‘ë™');
                
                aiModeBadge.textContent = "AI ON";
                aiModeBadge.className = "ai-mode-badge on";
                return true;

            } catch (error) {
                log(`âŒ AI ë¡œë“œ ì‹¤íŒ¨: ${error.message}`, 'error');
                updateStatus(mediapipeStatus, 'error', 'ë¡œë“œ ì‹¤íŒ¨');
                aiModeBadge.textContent = "AI ERROR";
                aiModeBadge.className = "ai-mode-badge off";
                return false;
            }
        }

        // ========== ìŠ¤ìº” ë¡œì§ (ê°€ì§œ ë°ì´í„° ì œê±°ë¨) ==========
        async function scanCoin() {
            if (isProcessing) return;
            isProcessing = true;
            scanBtn.disabled = true;
            scanBtn.innerHTML = 'â³ ë¶„ì„ ì¤‘...';

            try {
                // 1. ì´ë¯¸ì§€ ìº¡ì²˜
                const canvas = document.getElementById('temp-canvas');
                const ctx = canvas.getContext('2d');
                canvas.width = 400; canvas.height = 400;
                
                // ì¤‘ì•™ í¬ë¡­
                const size = Math.min(video.videoWidth, video.videoHeight, 400);
                const sx = (video.videoWidth - size) / 2;
                const sy = (video.videoHeight - size) / 2;
                ctx.drawImage(video, sx, sy, size, size, 0, 0, 400, 400);

                // 2. OpenCV ì „ì²˜ë¦¬ (ëŒ€ë¹„ ê°•í™” + êµµê¸° ë³´ì •)
                if (typeof cv !== 'undefined') {
                    try {
                        let src = cv.imread(canvas);
                        cv.cvtColor(src, src, cv.COLOR_RGBA2GRAY);
                        cv.GaussianBlur(src, src, new cv.Size(3, 3), 0);
                        cv.adaptiveThreshold(src, src, 255, cv.ADAPTIVE_THRESH_GAUSSIAN_C, cv.THRESH_BINARY_INV, 11, 2);
                        
                        // ëª¨í´ë¡œì§€ ë‹«ê¸° (ìˆ«ì ëŠì–´ì§ ë³´ì™„)
                        let M = cv.Mat.ones(3, 3, cv.CV_8U);
                        cv.morphologyEx(src, src, cv.MORPH_CLOSE, M);
                        
                        // ë°˜ì „ (ì›ë˜ëŒ€ë¡œ)
                        cv.bitwise_not(src, src);
                        cv.imshow(canvas, src);
                        src.delete(); M.delete();
                    } catch(e) { console.log("OpenCV íŒ¨ìŠ¤"); }
                }

                // 3. AI ì¸ì‹ ì‹¤í–‰
                if (!textRecognizer) throw new Error("AIê°€ ì•„ì§ ì¤€ë¹„ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
                
                const result = await textRecognizer.recognize(canvas);
                const text = result.paragraphs.map(p => p.text).join(" ");
                log(`ğŸ“¡ ì¸ì‹ ì›ë¬¸: "${text}"`, 'info');

                // 4. ë°ì´í„° íŒŒì‹±
                const numbers = text.match(/\d+/g) || [];
                let amount = "ë¯¸í™•ì¸";
                let year = "ë¯¸í™•ì¸";

                numbers.forEach(n => {
                    if (n.length === 4 && (n.startsWith('19') || n.startsWith('20'))) year = n;
                    if (['10', '50', '100', '500'].includes(n)) amount = n;
                });

                if (amount === "ë¯¸í™•ì¸" && year === "ë¯¸í™•ì¸") {
                    log("âš ï¸ ìˆ«ìë¥¼ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì°ì–´ì£¼ì„¸ìš”.", "warn");
                } else {
                    log(`ğŸ’° ë°œê²¬: ${year}ë…„ ${amount}ì›`, 'success');
                    
                    // ì €ì¥
                    canvas.toBlob((blob) => {
                        const tx = db.transaction('coins', 'readwrite');
                        tx.objectStore('coins').add({
                            amount, year, image: blob,
                            time: new Date().toISOString()
                        });
                        tx.oncomplete = () => loadCoins();
                    }, 'image/jpeg');
                }

            } catch (error) {
                log(`âŒ ìŠ¤ìº” ì˜¤ë¥˜: ${error.message}`, 'error');
            } finally {
                isProcessing = false;
                scanBtn.disabled = false;
                scanBtn.innerHTML = 'ğŸ“· ë™ì „ ìŠ¤ìº”';
            }
        }

        // ========== ì´ˆê¸°í™” ë° ì´ë²¤íŠ¸ ì—°ê²° ==========
        async function start() {
            log("ğŸš€ ì‹œìŠ¤í…œ ì´ˆê¸°í™” ì‹œì‘...", "info");
            
            await initDatabase();
            
            // ì¹´ë©”ë¼ ì—°ê²°
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
                video.srcObject = stream;
                videoTrack = stream.getVideoTracks()[0];
                updateStatus(cameraStatus, 'success', 'ì—°ê²°ë¨');
                
                // ë²„íŠ¼ í™œì„±í™” ì²´í¬
                const caps = videoTrack.getCapabilities();
                if (caps.torch) torchBtn.disabled = false;
                if (caps.focusMode && caps.focusMode.includes('manual')) macroBtn.disabled = false;
                
            } catch(e) {
                log("ì¹´ë©”ë¼ ì—°ê²° ì‹¤íŒ¨: " + e.message, "error");
                updateStatus(cameraStatus, 'error', 'ì‹¤íŒ¨');
            }

            // AI ì´ˆê¸°í™”
            await initAI();
            
            // OpenCV ìƒíƒœ ì²´í¬
            if (typeof cv !== 'undefined') updateStatus(opencvStatus, 'success', 'ì¤€ë¹„ë¨');

            // ë²„íŠ¼ ì´ë²¤íŠ¸ ì—°ê²° (ëª¨ë“ˆ ë‚´ë¶€ì—ì„œ ì—°ê²°í•´ì•¼ í•¨)
            scanBtn.onclick = scanCoin;
            
            torchBtn.onclick = async () => {
                isTorchOn = !isTorchOn;
                await videoTrack.applyConstraints({ advanced: [{ torch: isTorchOn }] });
                log(`ë¼ì´íŠ¸ ${isTorchOn ? 'ON' : 'OFF'}`, 'info');
            };

            macroBtn.onclick = async () => {
                isMacroOn = !isMacroOn;
                await videoTrack.applyConstraints({ 
                    advanced: [{ focusMode: isMacroOn ? 'manual' : 'continuous', focusDistance: isMacroOn ? 0.1 : undefined }] 
                });
                log(`ì ‘ì‚¬ëª¨ë“œ ${isMacroOn ? 'ON' : 'OFF'}`, 'info');
            };
            
            reloadBtn.onclick = () => location.reload();
            scanBtn.disabled = false;
        }

        // OpenCV ë¡œë“œ ëŒ€ê¸° í›„ ì‹œì‘
        if (typeof cv !== 'undefined') start();
        else setTimeout(start, 1000);

    </script>
</body>
</html>