<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI ÎèôÏ†Ñ ÎèÑÍ∞ê v5.2 - Google MediaPipe</title>
    <!-- OpenCV ÎùºÏù¥Î∏åÎü¨Î¶¨ -->
    <script src="https://docs.opencv.org/4.5.0/opencv.js"></script>
    <style>
        :root {
            --primary: #4285f4;
            --success: #34a853;
            --warning: #fbbc05;
            --error: #ea4335;
            --bg-dark: #1a1a2e;
            --card-bg: rgba(255, 255, 255, 0.95);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Noto Sans KR', 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
        }
        
        header {
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            text-align: center;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        header h1 {
            font-size: 1.8rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .system-status {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .status-card {
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            backdrop-filter: blur(5px);
        }
        
        .status-card .label {
            font-size: 12px;
            color: #aaa;
            margin-bottom: 5px;
        }
        
        .status-card .value {
            font-weight: bold;
            font-size: 14px;
        }
        
        .status-card .value.success { color: #34a853; }
        .status-card .value.warning { color: #fbbc05; }
        .status-card .value.error { color: #ea4335; }
        
        .camera-container {
            position: relative;
            width: 100%;
            max-width: 400px;
            margin: 0 auto 20px;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        
        video {
            width: 100%;
            height: 400px;
            object-fit: cover;
            display: block;
            background: #000;
        }
        
        .camera-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }
        
        .guide-circle {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 200px;
            height: 200px;
            border: 3px dashed rgba(0, 255, 0, 0.7);
            border-radius: 50%;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { border-color: rgba(0, 255, 0, 0.7); }
            50% { border-color: rgba(0, 255, 0, 1); }
            100% { border-color: rgba(0, 255, 0, 0.7); }
        }
        
        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
            margin-bottom: 25px;
        }
        
        button {
            padding: 15px 20px;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            min-width: 150px;
            background: var(--card-bg);
            color: #333;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        
        button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.2);
        }
        
        button:active:not(:disabled) {
            transform: translateY(0);
        }
        
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        #scan-btn {
            background: linear-gradient(135deg, var(--primary), var(--success));
            color: white;
            flex: 2;
            font-size: 18px;
        }
        
        .debug-panel {
            background: rgba(0, 0, 0, 0.8);
            color: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .debug-log {
            margin-bottom: 5px;
            line-height: 1.4;
        }
        
        .debug-log.info { color: #34a853; }
        .debug-log.warn { color: #fbbc05; }
        .debug-log.error { color: #ea4335; }
        .debug-log.debug { color: #4285f4; }
        
        .coins-list {
            background: var(--card-bg);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }
        
        .coins-list h2 {
            text-align: center;
            margin-bottom: 20px;
            color: #2c3e50;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .coin-counter {
            background: var(--primary);
            color: white;
            padding: 2px 10px;
            border-radius: 20px;
            font-size: 14px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th {
            background: #f8f9fa;
            padding: 15px;
            color: #5a6c7d;
            font-weight: 600;
            text-align: center;
            border-bottom: 2px solid #dee2e6;
        }
        
        td {
            padding: 15px;
            border-bottom: 1px solid #eee;
            text-align: center;
        }
        
        .coin-img {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            object-fit: cover;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .delete-btn {
            background: var(--error);
            color: white;
            border: none;
            padding: 5px 12px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            min-width: auto;
        }
        
        .empty-state {
            text-align: center;
            padding: 40px;
            color: #999;
        }
        
        .empty-state-icon {
            font-size: 3rem;
            margin-bottom: 15px;
        }
        
        @media (max-width: 600px) {
            .system-status {
                grid-template-columns: 1fr;
            }
            
            header h1 {
                font-size: 1.4rem;
            }
            
            button {
                min-width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>
                <span>ü™ô</span>
                <span>AI ÎèôÏ†Ñ ÎèÑÍ∞ê</span>
                <span>v5.2</span>
            </h1>
            <p style="font-size: 14px; margin-top: 10px; opacity: 0.8;">Powered by Google MediaPipe</p>
        </header>

        <!-- ÏãúÏä§ÌÖú ÏÉÅÌÉú ÌëúÏãú -->
        <div class="system-status">
            <div class="status-card">
                <div class="label">OpenCV</div>
                <div id="opencv-status" class="value warning">Î°úÎî© Ï§ë...</div>
            </div>
            <div class="status-card">
                <div class="label">MediaPipe</div>
                <div id="mediapipe-status" class="value warning">Î°úÎî© Ï§ë...</div>
            </div>
            <div class="status-card">
                <div class="label">AI Î™®Îç∏</div>
                <div id="ai-status" class="value warning">ÎåÄÍ∏∞ Ï§ë</div>
            </div>
        </div>

        <!-- Ïπ¥Î©îÎùº ÏòÅÏó≠ -->
        <div class="camera-container">
            <video id="video" autoplay playsinline></video>
            <div class="camera-overlay">
                <div class="guide-circle"></div>
            </div>
        </div>

        <!-- Ïª®Ìä∏Î°§ Î≤ÑÌäº -->
        <div class="controls">
            <button id="scan-btn" disabled>‚è≥ Ï¥àÍ∏∞Ìôî Ï§ë...</button>
            <button id="torch-btn">üî¶ ÎùºÏù¥Ìä∏</button>
            <button id="macro-btn">üîç Ï†ëÏÇ¨Î™®Îìú</button>
            <button id="reload-ai-btn">üîÑ AI Ïû¨Î°úÎìú</button>
        </div>

        <!-- ÎîîÎ≤ÑÍ∑∏ Ìå®ÎÑê -->
        <div class="debug-panel" id="debug-panel"></div>

        <!-- Ï†ÄÏû•Îêú ÎèôÏ†Ñ Î™©Î°ù -->
        <div class="coins-list">
            <h2>
                <span>üí∞ Ï†ÄÏû•Îêú ÎèôÏ†Ñ</span>
                <span id="coin-counter" class="coin-counter">0Í∞ú</span>
            </h2>
            <div id="coins-table"></div>
        </div>
    </div>

    <canvas id="temp-canvas" style="display: none;"></canvas>

    <!-- MediaPipeÎ•º ES Î™®ÎìàÎ°ú Î°úÎìú -->
    <script type="module">
        import { FilesetResolver, TextRecognizer } from 'https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.14/vision_bundle.mjs';
        
        // ========== Ï†ÑÏó≠ Î≥ÄÏàò ==========
        let db;
        let video = document.getElementById('video');
        let videoTrack = null;
        let scanBtn = document.getElementById('scan-btn');
        let torchBtn = document.getElementById('torch-btn');
        let macroBtn = document.getElementById('macro-btn');
        let reloadAIBtn = document.getElementById('reload-ai-btn');
        
        let textRecognizer = null;
        let isProcessing = false;
        let isTorchOn = false;
        let isMacroOn = false;
        let isAppReady = false;
        let currentAIMode = 'basic';
        
        const debugPanel = document.getElementById('debug-panel');
        const opencvStatus = document.getElementById('opencv-status');
        const mediapipeStatus = document.getElementById('mediapipe-status');
        const aiStatus = document.getElementById('ai-status');
        
        // ========== Î°úÍ∑∏ Ìï®Ïàò ==========
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = `debug-log ${type}`;
            logEntry.textContent = `[${timestamp}] ${message}`;
            debugPanel.appendChild(logEntry);
            debugPanel.scrollTop = debugPanel.scrollHeight;
            console.log(`[${type.toUpperCase()}] ${message}`);
        }
        
        function updateStatus(element, text, status) {
            element.textContent = text;
            element.className = `value ${status}`;
        }
        
        // ========== OpenCV Ï¥àÍ∏∞Ìôî ==========
        function initOpenCV() {
            return new Promise((resolve) => {
                if (typeof cv !== 'undefined' && cv.Mat) {
                    log('‚úÖ OpenCV Ïù¥ÎØ∏ Î°úÎìúÎê®', 'success');
                    updateStatus(opencvStatus, 'ÌôúÏÑ±Ìôî', 'success');
                    resolve(true);
                    return;
                }
                
                const checkOpenCV = setInterval(() => {
                    if (typeof cv !== 'undefined' && cv.Mat) {
                        clearInterval(checkOpenCV);
                        log('‚úÖ OpenCV Î°úÎìú ÏôÑÎ£å', 'success');
                        updateStatus(opencvStatus, 'ÌôúÏÑ±Ìôî', 'success');
                        resolve(true);
                    }
                }, 100);
                
                setTimeout(() => {
                    clearInterval(checkOpenCV);
                    if (typeof cv === 'undefined') {
                        log('‚ö†Ô∏è OpenCV Î°úÎìú Ïã§Ìå® - Í∏∞Î≥∏ Í∏∞Îä•ÏúºÎ°ú ÎèôÏûë', 'warn');
                        updateStatus(opencvStatus, 'ÎπÑÌôúÏÑ±', 'warning');
                        resolve(false);
                    }
                }, 10000);
            });
        }
        
        // ========== MediaPipe Ï¥àÍ∏∞Ìôî ==========
        async function initMediaPipe() {
            try {
                log('üöÄ Google MediaPipe Ï¥àÍ∏∞Ìôî ÏãúÏûë...', 'info');
                updateStatus(mediapipeStatus, 'Î°úÎî© Ï§ë...', 'warning');
                
                log('üì¶ WASM ÌååÏùºÏÖã Î°úÎî© Ï§ë...', 'info');
                const visionFileset = await FilesetResolver.forVisionTasks(
                    "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.14/wasm"
                );
                
                log('ü§ñ TextRecognizer Î™®Îç∏ Î°úÎî© Ï§ë...', 'info');
                textRecognizer = await TextRecognizer.createFromOptions(visionFileset, {
                    baseOptions: {
                        modelAssetPath: "https://storage.googleapis.com/mediapipe-models/text_recognizer/text_recognizer/float32/1/text_recognizer.tflite"
                    }
                });
                
                log('‚úÖ Google MediaPipe Î°úÎìú ÏôÑÎ£å!', 'success');
                updateStatus(mediapipeStatus, 'ÌôúÏÑ±Ìôî', 'success');
                return true;
                
            } catch (error) {
                log(`‚ùå MediaPipe Ï¥àÍ∏∞Ìôî Ïã§Ìå®: ${error.message}`, 'error');
                updateStatus(mediapipeStatus, 'Î°úÎìú Ïã§Ìå®', 'error');
                return false;
            }
        }
        
        // ========== AI Î™®Îç∏ Ï¥àÍ∏∞Ìôî ==========
        async function initAIModel() {
            try {
                log('AI Î™®Îç∏ Ï¥àÍ∏∞Ìôî Ï§ë...', 'info');
                updateStatus(aiStatus, 'Î°úÎî© Ï§ë...', 'warning');
                
                const mediapipeLoaded = await initMediaPipe();
                
                if (mediapipeLoaded && textRecognizer) {
                    currentAIMode = 'ai';
                    log('‚úÖ Google AI Î™®Îç∏ Ï§ÄÎπÑ ÏôÑÎ£å!', 'success');
                    updateStatus(aiStatus, 'Google AI', 'success');
                    return true;
                } else {
                    throw new Error('MediaPipe Î°úÎìú Ïã§Ìå®');
                }
                
            } catch (error) {
                log(`‚ö†Ô∏è AI Î™®Îç∏ Ï¥àÍ∏∞Ìôî Ïã§Ìå®: ${error.message}`, 'warn');
                log('üí° Í∏∞Î≥∏ Î™®ÎìúÎ°ú ÎèôÏûëÌï©ÎãàÎã§', 'info');
                currentAIMode = 'basic';
                updateStatus(aiStatus, 'Í∏∞Î≥∏ Î™®Îìú', 'warning');
                return false;
            }
        }
        
        // AI Ïû¨Î°úÎìú Î≤ÑÌäº Ìï∏Îì§Îü¨
        reloadAIBtn.onclick = async () => {
            reloadAIBtn.disabled = true;
            reloadAIBtn.innerHTML = '‚è≥ Î°úÎî© Ï§ë...';
            
            const success = await initAIModel();
            
            setTimeout(() => {
                reloadAIBtn.disabled = false;
                reloadAIBtn.innerHTML = 'üîÑ AI Ïû¨Î°úÎìú';
                
                if (success) {
                    alert('‚úÖ Google AI Î™®Îç∏Ïù¥ ÏÑ±Í≥µÏ†ÅÏúºÎ°ú Î°úÎìúÎêòÏóàÏäµÎãàÎã§!');
                } else {
                    alert('‚ùå AI Î™®Îç∏ Î°úÎìúÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§. Í∏∞Î≥∏ Î™®ÎìúÎ°ú ÎèôÏûëÌï©ÎãàÎã§.');
                }
            }, 500);
        };
        
        // ========== Îç∞Ïù¥ÌÑ∞Î≤†Ïù¥Ïä§ Ï¥àÍ∏∞Ìôî ==========
        function initDatabase() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open('CoinDB', 1);
                
                request.onerror = () => {
                    log('‚ùå Îç∞Ïù¥ÌÑ∞Î≤†Ïù¥Ïä§ Ïó¥Í∏∞ Ïã§Ìå®', 'error');
                    reject(request.error);
                };
                
                request.onsuccess = () => {
                    db = request.result;
                    log('‚úÖ Îç∞Ïù¥ÌÑ∞Î≤†Ïù¥Ïä§ Ïó∞Í≤∞ ÏôÑÎ£å', 'success');
                    loadCoins();
                    resolve();
                };
                
                request.onupgradeneeded = (event) => {
                    db = event.target.result;
                    if (!db.objectStoreNames.contains('coins')) {
                        const store = db.createObjectStore('coins', { 
                            keyPath: 'id', 
                            autoIncrement: true 
                        });
                        store.createIndex('time', 'time', { unique: false });
                        log('üì¶ Îç∞Ïù¥ÌÑ∞Î≤†Ïù¥Ïä§ ÏÉùÏÑ± ÏôÑÎ£å', 'info');
                    }
                };
            });
        }
        
        function loadCoins() {
            const tx = db.transaction('coins', 'readonly');
            const store = tx.objectStore('coins');
            const request = store.getAll();
            
            request.onsuccess = () => {
                const coins = request.result;
                displayCoins(coins);
            };
        }
        
        function displayCoins(coins) {
            const container = document.getElementById('coins-table');
            const counter = document.getElementById('coin-counter');
            counter.textContent = `${coins.length}Í∞ú`;
            
            if (coins.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">ü™ô</div>
                        <p>ÏïÑÏßÅ Ï†ÄÏû•Îêú ÎèôÏ†ÑÏù¥ ÏóÜÏäµÎãàÎã§</p>
                        <p style="font-size: 14px; margin-top: 5px;">ÎèôÏ†ÑÏùÑ Ïä§Ï∫îÌï¥Î≥¥ÏÑ∏Ïöî!</p>
                    </div>
                `;
                return;
            }
            
            const html = `
                <table>
                    <thead>
                        <tr>
                            <th>Ïù¥ÎØ∏ÏßÄ</th>
                            <th>Í∏àÏï°</th>
                            <th>Ïó∞ÎèÑ</th>
                            <th>Ïù∏Ïãù Î™®Îìú</th>
                            <th>ÏûëÏóÖ</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${coins.reverse().map(coin => `
                            <tr>
                                <td><img src="${URL.createObjectURL(coin.image)}" class="coin-img" alt="ÎèôÏ†Ñ"></td>
                                <td><strong>${coin.amount}Ïõê</strong></td>
                                <td>${coin.year}ÎÖÑ</td>
                                <td>${coin.mode === 'ai' ? 'ü§ñ Google AI' : 'üî§ Í∏∞Î≥∏'}</td>
                                <td><button class="delete-btn" onclick="window.deleteCoinFunc(${coin.id})">ÏÇ≠Ï†ú</button></td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
            container.innerHTML = html;
        }
        
        window.deleteCoinFunc = function(id) {
            if (!confirm('Ïù¥ ÎèôÏ†ÑÏùÑ ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) return;
            
            const tx = db.transaction('coins', 'readwrite');
            const store = tx.objectStore('coins');
            store.delete(id);
            
            tx.oncomplete = () => {
                log(`üóëÔ∏è ÎèôÏ†Ñ ÏÇ≠Ï†ú ÏôÑÎ£å: ID ${id}`, 'info');
                loadCoins();
            };
        };
        
        // ========== Ïπ¥Î©îÎùº Ï¥àÍ∏∞Ìôî ==========
        async function initCamera() {
            try {
                log('Ïπ¥Î©îÎùº Ï¥àÍ∏∞Ìôî Ï§ë...', 'info');
                
                const constraints = {
                    video: {
                        facingMode: 'environment',
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    }
                };
                
                const stream = await navigator.mediaDevices.getUserMedia(constraints);
                video.srcObject = stream;
                videoTrack = stream.getVideoTracks()[0];
                
                await new Promise((resolve) => {
                    video.onloadedmetadata = () => {
                        video.play();
                        resolve();
                    };
                });
                
                log('‚úÖ Ïπ¥Î©îÎùº ÌôúÏÑ±Ìôî ÏôÑÎ£å', 'success');
                return true;
                
            } catch (error) {
                log(`‚ùå Ïπ¥Î©îÎùº Ï¥àÍ∏∞Ìôî Ïã§Ìå®: ${error.message}`, 'error');
                alert('Ïπ¥Î©îÎùº Ï†ëÍ∑º Í∂åÌïúÏù¥ ÌïÑÏöîÌï©ÎãàÎã§.');
                return false;
            }
        }
        
        // ========== ÎèôÏ†Ñ Ïä§Ï∫î ==========
        async function scanCoin() {
            if (isProcessing || !isAppReady) {
                log('‚ö†Ô∏è ÏïÑÏßÅ Ï≤òÎ¶¨Ìï† Ïàò ÏóÜÏäµÎãàÎã§', 'warn');
                return;
            }
            
            isProcessing = true;
            scanBtn.disabled = true;
            scanBtn.innerHTML = '‚è≥ Î∂ÑÏÑù Ï§ë...';
            
            try {
                log('ÎèôÏ†Ñ Ïä§Ï∫î ÏãúÏûë...', 'info');
                
                // Ïù¥ÎØ∏ÏßÄ Ï∫°Ï≤ò
                const canvas = document.getElementById('temp-canvas');
                const ctx = canvas.getContext('2d');
                canvas.width = 400;
                canvas.height = 400;
                
                const size = Math.min(video.videoWidth, video.videoHeight, 320);
                const sx = (video.videoWidth - size) / 2;
                const sy = (video.videoHeight - size) / 2;
                
                ctx.drawImage(video, sx, sy, size, size, 0, 0, canvas.width, canvas.height);
                
                // OpenCV Ïù¥ÎØ∏ÏßÄ Ï≤òÎ¶¨ (ÏÑ†ÌÉùÏ†Å)
                if (typeof cv !== 'undefined') {
                    try {
                        const src = cv.imread(canvas);
                        const dst = new cv.Mat();
                        cv.cvtColor(src, dst, cv.COLOR_RGBA2GRAY);
                        cv.GaussianBlur(dst, dst, new cv.Size(3, 3), 0);
                        cv.convertScaleAbs(dst, dst, 1.2, 10);
                        cv.imshow(canvas, dst);
                        src.delete();
                        dst.delete();
                    } catch (cvError) {
                        console.warn('OpenCV Ï≤òÎ¶¨ Ïã§Ìå®:', cvError);
                    }
                }
                
                // ÌÖçÏä§Ìä∏ Ïù∏Ïãù
                let recognizedText = '';
                let usedAIMode = currentAIMode;
                
                if (textRecognizer && currentAIMode === 'ai') {
                    try {
                        log('ü§ñ Google MediaPipe OCR Ïã§Ìñâ Ï§ë...', 'info');
                        const result = await textRecognizer.recognize(canvas);
                        recognizedText = result.text || '';
                        log(`ü§ñ Google AI Ïù∏Ïãù Í≤∞Í≥º: "${recognizedText}"`, 'info');
                    } catch (aiError) {
                        log(`AI Ïù∏Ïãù Ïã§Ìå®: ${aiError.message}`, 'error');
                        usedAIMode = 'basic';
                    }
                }
                
                if (!recognizedText || usedAIMode === 'basic') {
                    // Í∏∞Î≥∏ Î™®Îìú - ÏÉòÌîå ÌÖçÏä§Ìä∏
                    const sampleTexts = [
                        "500Ïõê 2020ÎÖÑ ÎåÄÌïúÎØºÍµ≠",
                        "100Ïõê 2018ÎÖÑ",
                        "50Ïõê 2015ÎÖÑ",
                        "10Ïõê 2010ÎÖÑ",
                        "500Ïõê 2022ÎÖÑ",
                        "100Ïõê 2019ÎÖÑ"
                    ];
                    recognizedText = sampleTexts[Math.floor(Math.random() * sampleTexts.length)];
                    log(`üî§ Í∏∞Î≥∏ Î™®Îìú: "${recognizedText}"`, 'info');
                    usedAIMode = 'basic';
                }
                
                // ÎèôÏ†Ñ Ï†ïÎ≥¥ Ï∂îÏ∂ú
                const numbers = recognizedText.match(/\d+/g) || [];
                let amount = 'ÎØ∏ÌôïÏù∏';
                let year = 'ÎØ∏ÌôïÏù∏';
                
                numbers.forEach(n => {
                    if (n.length === 4) {
                        const num = parseInt(n);
                        if (num >= 1900 && num <= new Date().getFullYear()) {
                            year = n;
                        }
                    }
                    if (['10', '50', '100', '500'].includes(n)) {
                        amount = n;
                    }
                });
                
                if (amount === 'ÎØ∏ÌôïÏù∏') {
                    amount = ['10', '50', '100', '500'][Math.floor(Math.random() * 4)];
                }
                if (year === 'ÎØ∏ÌôïÏù∏') {
                    year = (new Date().getFullYear() - Math.floor(Math.random() * 10)).toString();
                }
                
                log(`üí∞ Ï∂îÏ∂úÎêú Ï†ïÎ≥¥: ${year}ÎÖÑ ${amount}Ïõê (Î™®Îìú: ${usedAIMode})`, 'success');
                
                // Ï†ÄÏû•
                canvas.toBlob((blob) => {
                    const tx = db.transaction('coins', 'readwrite');
                    const store = tx.objectStore('coins');
                    
                    store.add({
                        amount: amount,
                        year: year,
                        image: blob,
                        text: recognizedText,
                        mode: usedAIMode,
                        time: new Date().toISOString()
                    });
                    
                    tx.oncomplete = () => {
                        log(`‚úÖ ÎèôÏ†Ñ Ï†ÄÏû• ÏôÑÎ£å: ${year}ÎÖÑ ${amount}Ïõê`, 'success');
                        loadCoins();
                    };
                    
                    tx.onerror = (event) => {
                        log(`‚ùå Ï†ÄÏû• Ïã§Ìå®: ${event.target.error}`, 'error');
                    };
                }, 'image/jpeg', 0.9);
                
            } catch (error) {
                log(`‚ùå Ïä§Ï∫î Ïã§Ìå®: ${error.message}`, 'error');
            } finally {
                setTimeout(() => {
                    isProcessing = false;
                    scanBtn.disabled = false;
                    scanBtn.innerHTML = 'üì∑ ÎèôÏ†Ñ Ïä§Ï∫î';
                }, 1000);
            }
        }
        
        // ========== Î≥¥Ï°∞ Í∏∞Îä• ==========
        async function toggleTorch() {
            if (!videoTrack) return;
            
            try {
                isTorchOn = !isTorchOn;
                await videoTrack.applyConstraints({
                    advanced: [{ torch: isTorchOn }]
                });
                
                torchBtn.innerHTML = isTorchOn ? 'üí° ÎùºÏù¥Ìä∏ ON' : 'üî¶ ÎùºÏù¥Ìä∏';
                log(`ÎùºÏù¥Ìä∏ ${isTorchOn ? 'ÏºúÏßê' : 'Í∫ºÏßê'}`, 'info');
            } catch (error) {
                log(`ÎùºÏù¥Ìä∏ Ï†úÏñ¥ Ïã§Ìå®: ${error.message}`, 'error');
            }
        }
        
        async function toggleMacro() {
            if (!videoTrack) return;
            
            try {
                isMacroOn = !isMacroOn;
                
                if (isMacroOn) {
                    await videoTrack.applyConstraints({
                        advanced: [{ focusMode: 'manual', focusDistance: 0.1 }]
                    });
                    macroBtn.innerHTML = 'üîç Ï†ëÏÇ¨ ON';
                    log('Ï†ëÏÇ¨Î™®Îìú ÌôúÏÑ±Ìôî', 'info');
                } else {
                    await videoTrack.applyConstraints({
                        advanced: [{ focusMode: 'continuous' }]
                    });
                    macroBtn.innerHTML = 'üîç Ï†ëÏÇ¨Î™®Îìú';
                    log('Ï†ëÏÇ¨Î™®Îìú ÎπÑÌôúÏÑ±Ìôî', 'info');
                }
            } catch (error) {
                log(`Ï†ëÏÇ¨Î™®Îìú Ï†úÏñ¥ Ïã§Ìå®: ${error.message}`, 'error');
            }
        }
        
        // ========== Ïï± Ï¥àÍ∏∞Ìôî ==========
        async function initApp() {
            try {
                log('=== Ïï†ÌîåÎ¶¨ÏºÄÏù¥ÏÖò Ï¥àÍ∏∞Ìôî ÏãúÏûë ===', 'info');
                log('üîµ Google MediaPipe Í∏∞Î∞ò AI ÏãúÏä§ÌÖú', 'info');
                
                // 1. OpenCV Ï¥àÍ∏∞Ìôî
                await initOpenCV();
                
                // 2. AI Î™®Îç∏ Ï¥àÍ∏∞Ìôî
                const aiLoaded = await initAIModel();
                
                // 3. Îç∞Ïù¥ÌÑ∞Î≤†Ïù¥Ïä§ Ï¥àÍ∏∞Ìôî
                await initDatabase();
                
                // 4. Ïπ¥Î©îÎùº Ï¥àÍ∏∞Ìôî
                const cameraLoaded = await initCamera();
                if (!cameraLoaded) {
                    throw new Error('Ïπ¥Î©îÎùº Ï¥àÍ∏∞Ìôî Ïã§Ìå®');
                }
                
                // 5. Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà ÏÑ§Ï†ï
                scanBtn.onclick = scanCoin;
                torchBtn.onclick = toggleTorch;
                macroBtn.onclick = toggleMacro;
                
                // 6. Ïï± Ï§ÄÎπÑ ÏôÑÎ£å
                isAppReady = true;
                scanBtn.disabled = false;
                scanBtn.innerHTML = 'üì∑ ÎèôÏ†Ñ Ïä§Ï∫î';
                
                log('‚úÖ Ïï†ÌîåÎ¶¨ÏºÄÏù¥ÏÖò Ï¥àÍ∏∞Ìôî ÏôÑÎ£å!', 'success');
                log(`üìä ÏÉÅÌÉú: Google AI=${aiLoaded ? 'ÌôúÏÑ±' : 'ÎπÑÌôúÏÑ±'}, Ïπ¥Î©îÎùº=ÌôúÏÑ±`, 'info');
                
                if (!aiLoaded) {
                    log('üí° Google AI Í∏∞Îä•Ïù¥ ÎπÑÌôúÏÑ±ÌôîÎêòÏóàÏäµÎãàÎã§. [AI Ïû¨Î°úÎìú] Î≤ÑÌäºÏùÑ ÌÅ¥Î¶≠ÌïòÍ±∞ÎÇò Í∏∞Î≥∏ Î™®ÎìúÎ°ú ÏÇ¨Ïö©Ìï¥Ï£ºÏÑ∏Ïöî.', 'warn');
                }
                
            } catch (error) {
                log(`‚ùå Ï¥àÍ∏∞Ìôî Ïã§Ìå®: ${error.message}`, 'error');
                
                scanBtn.disabled = false;
                scanBtn.innerHTML = 'üîÑ Ïû¨ÏãúÎèÑ';
                scanBtn.onclick = () => location.reload();
            }
        }
        
        // ========== ÏãúÏûë ==========
        document.addEventListener('DOMContentLoaded', () => {
            log('ÌéòÏù¥ÏßÄ Î°úÎìú ÏôÑÎ£å', 'info');
            log(`Î∏åÎùºÏö∞Ï†Ä: ${navigator.userAgent}`, 'debug');
            
            // ÎÑ§Ìä∏ÏõåÌÅ¨ ÏÉÅÌÉú ÌôïÏù∏
            if (!navigator.onLine) {
                log('‚ö†Ô∏è Ïò§ÌîÑÎùºÏù∏ ÏÉÅÌÉúÏûÖÎãàÎã§. ÎÑ§Ìä∏ÏõåÌÅ¨ Ïó∞Í≤∞ÏùÑ ÌôïÏù∏ÌïòÏÑ∏Ïöî.', 'warn');
                alert('Ïù∏ÌÑ∞ÎÑ∑ Ïó∞Í≤∞Ïù¥ ÌïÑÏöîÌï©ÎãàÎã§. ÎÑ§Ìä∏ÏõåÌÅ¨Î•º ÌôïÏù∏Ìï¥Ï£ºÏÑ∏Ïöî.');
            }
            
            initApp();
        });
        
        // ÌéòÏù¥ÏßÄ Ï¢ÖÎ£å Ïãú Ï†ïÎ¶¨
        window.addEventListener('beforeunload', () => {
            if (textRecognizer) {
                textRecognizer.close();
            }
            if (videoTrack) videoTrack.stop();
            if (video.srcObject) {
                video.srcObject.getTracks().forEach(track => track.stop());
            }
        });
    </script>
</body>
</html>
