<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI Coin Collector v5.0</title>
    <!-- OpenCV ë¼ì´ë¸ŒëŸ¬ë¦¬ -->
    <script src="https://docs.opencv.org/4.5.0/opencv.js"></script>
    <!-- MediaPipe ë¼ì´ë¸ŒëŸ¬ë¦¬ (CDN ê²½ë¡œ ë³€ê²½) -->
    <script src="https://unpkg.com/@mediapipe/tasks-vision@0.10.3/vision_bundle.js"></script>
    <style>
        :root { 
            --primary: #4285f4; 
            --terminal: #1e1e1e; 
            --success: #34a853;
            --warning: #f39c12;
            --danger: #e74c3c;
        }
        
        * { 
            box-sizing: border-box; 
            margin: 0;
            padding: 0;
        }
        
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif; 
            background: linear-gradient(135deg, #1a2980, #26d0ce);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px 15px 40px;
            color: #333;
        }
        
        header { 
            width: 100%; 
            max-width: 600px;
            padding: 20px; 
            background: rgba(0, 0, 0, 0.9); 
            color: white; 
            text-align: center;
            border-radius: 20px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            border: 1px solid rgba(255,255,255,0.1);
        }
        
        header h1 {
            margin: 0;
            font-size: 1.9rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
        }
        
        .debug-panel {
            width: 100%;
            max-width: 600px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.5;
        }
        
        .debug-title {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(255,255,255,0.2);
        }
        
        .debug-title h3 {
            margin: 0;
            color: #4285f4;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .debug-content {
            height: 200px;
            overflow-y: auto;
            background: #111;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
        }
        
        .debug-log {
            margin-bottom: 5px;
        }
        
        .debug-log.info { color: #00ff00; }
        .debug-log.warn { color: #f39c12; }
        .debug-log.error { color: #e74c3c; }
        .debug-log.debug { color: #4285f4; }
        
        .status-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 20px;
            width: 100%;
            max-width: 600px;
        }
        
        .status-card {
            background: rgba(0, 0, 0, 0.7);
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            border: 1px solid rgba(255,255,255,0.1);
        }
        
        .status-card .label {
            font-size: 12px;
            color: #aaa;
            margin-bottom: 5px;
        }
        
        .status-card .value {
            font-weight: bold;
            font-size: 16px;
        }
        
        .status-card .value.ready { color: #2ecc71; }
        .status-card .value.loading { color: #f39c12; }
        .status-card .value.error { color: #e74c3c; }
        
        .viewport { 
            position: relative; 
            width: 100%; 
            max-width: 400px; 
            aspect-ratio: 1/1; 
            margin: 0 0 20px; 
            border-radius: 20px; 
            overflow: hidden; 
            background: #000; 
            border: 4px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 15px 40px rgba(0,0,0,0.4);
        }
        
        video { 
            width: 100%; 
            height: 100%; 
            object-fit: cover;
            display: block;
        }
        
        .overlay { 
            position: absolute; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background: rgba(0,0,0,0.2);
            mask: radial-gradient(circle 100px at center, transparent 100px, black 100px);
            -webkit-mask: radial-gradient(circle 100px at center, transparent 100px, black 100px);
            pointer-events: none;
        }
        
        .guide-circle { 
            position: absolute; 
            top: 50%; 
            left: 50%; 
            transform: translate(-50%, -50%); 
            width: 200px; 
            height: 200px; 
            border: 3px dashed rgba(0, 255, 0, 0.8); 
            border-radius: 50%;
            pointer-events: none;
            animation: pulse 2s infinite ease-in-out;
        }
        
        @keyframes pulse {
            0% { border-color: rgba(0, 255, 0, 0.6); }
            50% { border-color: rgba(0, 255, 0, 1); }
            100% { border-color: rgba(0, 255, 0, 0.6); }
        }
        
        .btn-group { 
            display: flex; 
            flex-wrap: wrap; 
            justify-content: center; 
            gap: 10px; 
            margin-bottom: 25px; 
            width: 100%;
            max-width: 400px;
        }
        
        button { 
            padding: 16px 20px; 
            border-radius: 12px; 
            border: none; 
            font-weight: 600; 
            cursor: pointer; 
            background: rgba(255, 255, 255, 0.95);
            border: 2px solid rgba(255,255,255,0.3);
            color: #333;
            font-size: 16px;
            transition: all 0.25s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            flex: 1;
            min-width: 140px;
        }
        
        button:hover:not(:disabled) {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.25);
            background: white;
        }
        
        button:active:not(:disabled) {
            transform: translateY(-1px);
        }
        
        #scan-btn { 
            background: linear-gradient(135deg, #4285f4, #34a853); 
            color: white; 
            border: none; 
            flex: 2;
            font-size: 17px;
            font-weight: 700;
        }
        
        button:disabled { 
            background: #666 !important; 
            color: #999 !important; 
            cursor: not-allowed;
            transform: none !important;
            box-shadow: none !important;
        }
        
        .list-section { 
            width: 100%; 
            max-width: 600px; 
            background: rgba(255, 255, 255, 0.97);
            border-radius: 18px; 
            padding: 25px; 
            margin-bottom: 20px;
            box-shadow: 0 10px 35px rgba(0,0,0,0.15);
        }
        
        .list-section h2 {
            margin: 0 0 20px 0;
            color: #2c3e50;
            text-align: center;
            padding-bottom: 15px;
            border-bottom: 3px solid #eee;
            font-size: 1.6rem;
        }
        
        table { 
            width: 100%; 
            border-collapse: collapse; 
        }
        
        th {
            background: #f8f9fa;
            padding: 14px 12px;
            color: #5a6c7d;
            font-weight: 700;
            text-align: center;
            border-bottom: 3px solid #dee2e6;
            font-size: 15px;
        }
        
        td { 
            padding: 16px 12px; 
            border-bottom: 1px solid #f0f0f0; 
            text-align: center; 
            vertical-align: middle;
        }
        
        .coin-thumb { 
            width: 70px; 
            height: 70px; 
            border-radius: 50%; 
            object-fit: cover;
            border: 3px solid #4285f4;
            box-shadow: 0 4px 12px rgba(66, 133, 244, 0.3);
        }
        
        .empty-state {
            text-align: center;
            color: #7f8c8d;
            padding: 60px 20px;
            font-style: italic;
            font-size: 16px;
            line-height: 1.6;
        }
        
        footer {
            margin-top: 20px;
            color: rgba(255,255,255,0.7);
            font-size: 12px;
            text-align: center;
            max-width: 600px;
            padding: 0 20px;
        }
    </style>
</head>
<body>

<header>
    <h1>ğŸª™ AI ë™ì „ ë„ê° v5.0 - ë””ë²„ê·¸ ëª¨ë“œ</h1>
</header>

<div class="debug-panel">
    <div class="debug-title">
        <h3>ğŸ” ì‹œìŠ¤í…œ ë””ë²„ê·¸ ë¡œê·¸</h3>
        <button onclick="clearDebugLog()" style="background:#666; color:white; padding: 5px 10px; font-size: 12px;">ë¡œê·¸ ì§€ìš°ê¸°</button>
    </div>
    <div class="debug-content" id="debug-content">
        <!-- ë””ë²„ê·¸ ë¡œê·¸ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
    </div>
    <div class="status-grid">
        <div class="status-card">
            <div class="label">OpenCV ìƒíƒœ</div>
            <div class="value loading" id="opencv-status">í™•ì¸ ì¤‘...</div>
        </div>
        <div class="status-card">
            <div class="label">MediaPipe ìƒíƒœ</div>
            <div class="value loading" id="mediapipe-status">í™•ì¸ ì¤‘...</div>
        </div>
        <div class="status-card">
            <div class="label">ì¹´ë©”ë¼ ìƒíƒœ</div>
            <div class="value loading" id="camera-status">í™•ì¸ ì¤‘...</div>
        </div>
    </div>
</div>

<div class="viewport">
    <video id="webcam" autoplay playsinline></video>
    <div class="overlay"></div>
    <div class="guide-circle"></div>
</div>

<div class="btn-group">
    <button id="scan-btn" disabled>ğŸ“· ë™ì „ ìŠ¤ìº”</button>
    <button id="torch-btn" disabled>ğŸ”¦ ë¼ì´íŠ¸</button>
    <button id="macro-btn" disabled>ğŸ” ì ‘ì‚¬ëª¨ë“œ</button>
    <button onclick="location.reload()" style="background:#6c757d; color:white;">ğŸ”„ ì¬ì‹œì‘</button>
</div>

<div class="list-section">
    <h2>ğŸ“‚ ìˆ˜ì§‘ëœ ë™ì „ <span id="coin-count" style="color:#4285f4;">0</span></h2>
    <table>
        <thead>
            <tr>
                <th>ì´ë¯¸ì§€</th>
                <th>ê¸ˆì•¡</th>
                <th>ì—°ë„</th>
                <th>ì‹œê°„</th>
            </tr>
        </thead>
        <tbody id="coin-list">
            <tr>
                <td colspan="4" class="empty-state">ì•„ì§ ìˆ˜ì§‘ëœ ë™ì „ì´ ì—†ìŠµë‹ˆë‹¤.<br>ë™ì „ì„ ì¹´ë©”ë¼ ì¤‘ì•™ì— ë†“ê³  [ë™ì „ ìŠ¤ìº”] ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.</td>
            </tr>
        </tbody>
    </table>
</div>

<footer>
    AI ë™ì „ ì¸ì‹ ì‹œìŠ¤í…œ v5.0 | ë””ë²„ê·¸ ëª¨ë“œ í™œì„±í™” | MediaPipe ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë“œ í™•ì¸ ì¤‘
</footer>

<!-- ìˆ¨ê²¨ì§„ ìº”ë²„ìŠ¤ -->
<canvas id="temp-canvas" style="display:none;"></canvas>

<script>
    // ========== ë””ë²„ê·¸ ë¡œê¹… ì‹œìŠ¤í…œ ==========
    
    const debugContent = document.getElementById('debug-content');
    const opencvStatus = document.getElementById('opencv-status');
    const mediapipeStatus = document.getElementById('mediapipe-status');
    const cameraStatus = document.getElementById('camera-status');
    
    function debugLog(message, type = 'info') {
        const now = new Date();
        const timestamp = now.toTimeString().split(' ')[0];
        const logEntry = document.createElement('div');
        logEntry.className = `debug-log ${type}`;
        logEntry.textContent = `[${timestamp}] ${message}`;
        debugContent.appendChild(logEntry);
        debugContent.scrollTop = debugContent.scrollHeight;
        
        // ì½˜ì†”ì—ë„ ì¶œë ¥
        console.log(`[${type.toUpperCase()}] ${message}`);
    }
    
    function clearDebugLog() {
        debugContent.innerHTML = '';
        debugLog('ë¡œê·¸ê°€ ì§€ì›Œì¡ŒìŠµë‹ˆë‹¤', 'info');
    }
    
    function updateStatus(element, status, message) {
        element.textContent = message;
        element.className = 'value ' + status;
    }
    
    // ========== ì „ì—­ ë³€ìˆ˜ ==========
    
    const video = document.getElementById('webcam');
    const scanBtn = document.getElementById('scan-btn');
    const torchBtn = document.getElementById('torch-btn');
    const macroBtn = document.getElementById('macro-btn');
    const coinList = document.getElementById('coin-list');
    const coinCount = document.getElementById('coin-count');
    
    let textRecognizer = null;
    let db = null;
    let videoTrack = null;
    let isTorchOn = false;
    let isMacroOn = false;
    let isProcessing = false;
    let isAppReady = false;
    
    // ========== MediaPipe ë¼ì´ë¸ŒëŸ¬ë¦¬ ì§„ë‹¨ ==========
    
    function diagnoseMediaPipe() {
        debugLog('=== MediaPipe ë¼ì´ë¸ŒëŸ¬ë¦¬ ì§„ë‹¨ ì‹œì‘ ===', 'debug');
        
        // window ê°ì²´ í™•ì¸
        debugLog('window ê°ì²´ ê²€ì‚¬ ì¤‘...', 'debug');
        const windowKeys = Object.keys(window).filter(key => 
            key.toLowerCase().includes('mediapipe') || 
            key.toLowerCase().includes('vision') ||
            key.toLowerCase().includes('tasks')
        );
        
        debugLog(`ê´€ë ¨ window í‚¤: ${windowKeys.join(', ') || 'ì—†ìŒ'}`, 'debug');
        
        // íŠ¹ì • ê°ì²´ í™•ì¸
        const checkObjects = [
            'tasksVision',
            'Vision',
            'mediapipe',
            'MediaPipe',
            'TextRecognizer',
            'FilesetResolver'
        ];
        
        checkObjects.forEach(objName => {
            if (window[objName]) {
                debugLog(`âœ… window.${objName} ë°œê²¬: ${typeof window[objName]}`, 'info');
            } else {
                debugLog(`âŒ window.${objName} ì—†ìŒ`, 'warn');
            }
        });
        
        // ìŠ¤í¬ë¦½íŠ¸ íƒœê·¸ í™•ì¸
        const scripts = document.querySelectorAll('script');
        debugLog(`í˜ì´ì§€ì˜ ìŠ¤í¬ë¦½íŠ¸ íƒœê·¸ ìˆ˜: ${scripts.length}`, 'debug');
        scripts.forEach((script, i) => {
            if (script.src.includes('mediapipe') || script.src.includes('vision')) {
                debugLog(`ğŸ“œ ìŠ¤í¬ë¦½íŠ¸ ${i}: ${script.src}`, 'info');
            }
        });
        
        // CDN í…ŒìŠ¤íŠ¸
        testCDNAccess();
    }
    
    function testCDNAccess() {
        debugLog('CDN ì ‘ê·¼ì„± í…ŒìŠ¤íŠ¸ ì¤‘...', 'debug');
        
        const cdns = [
            'https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.3/vision_bundle.js',
            'https://unpkg.com/@mediapipe/tasks-vision@0.10.3/vision_bundle.js',
            'https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.0/vision_bundle.js'
        ];
        
        cdns.forEach((cdn, index) => {
            const testScript = document.createElement('script');
            testScript.src = cdn;
            testScript.onload = () => {
                debugLog(`âœ… CDN ${index+1} ì ‘ê·¼ ê°€ëŠ¥: ${cdn}`, 'info');
                testScript.remove();
            };
            testScript.onerror = () => {
                debugLog(`âŒ CDN ${index+1} ì ‘ê·¼ ë¶ˆê°€: ${cdn}`, 'error');
                testScript.remove();
            };
            
            // ì§§ì€ íƒ€ì„ì•„ì›ƒ ì„¤ì •
            setTimeout(() => {
                if (testScript.parentNode) {
                    testScript.remove();
                    debugLog(`âš ï¸ CDN ${index+1} íƒ€ì„ì•„ì›ƒ: ${cdn}`, 'warn');
                }
            }, 5000);
            
            document.head.appendChild(testScript);
        });
    }
    
    // ========== ë¼ì´ë¸ŒëŸ¬ë¦¬ ê°•ì œ ë¡œë“œ ==========
    
    async function loadMediaPipeForcibly() {
        debugLog('MediaPipe ë¼ì´ë¸ŒëŸ¬ë¦¬ ê°•ì œ ë¡œë“œ ì‹œì‘...', 'debug');
        updateStatus(mediapipeStatus, 'loading', 'ë¡œë“œ ì‹œë„ ì¤‘...');
        
        // ì—¬ëŸ¬ CDN ì‹œë„
        const cdns = [
            'https://unpkg.com/@mediapipe/tasks-vision@0.10.3/vision_bundle.js',
            'https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.3/vision_bundle.js',
            'https://esm.run/@mediapipe/tasks-vision@0.10.3'
        ];
        
        for (let i = 0; i < cdns.length; i++) {
            debugLog(`CDN ì‹œë„ ${i+1}/${cdns.length}: ${cdns[i]}`, 'debug');
            
            try {
                const loaded = await loadScript(cdns[i]);
                if (loaded) {
                    debugLog(`âœ… CDN ${i+1}ì—ì„œ ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë“œ ì„±ê³µ`, 'info');
                    
                    // ê°ì²´ í™•ì¸
                    await checkMediaPipeObjects();
                    return true;
                }
            } catch (error) {
                debugLog(`âŒ CDN ${i+1} ë¡œë“œ ì‹¤íŒ¨: ${error.message}`, 'error');
            }
        }
        
        debugLog('ëª¨ë“  CDN ì‹œë„ ì‹¤íŒ¨', 'error');
        updateStatus(mediapipeStatus, 'error', 'ë¡œë“œ ì‹¤íŒ¨');
        return false;
    }
    
    function loadScript(src) {
        return new Promise((resolve, reject) => {
            // ì´ë¯¸ ë¡œë“œë˜ì—ˆëŠ”ì§€ í™•ì¸
            if (window.tasksVision || window.Vision) {
                resolve(true);
                return;
            }
            
            const script = document.createElement('script');
            script.src = src;
            
            script.onload = () => {
                setTimeout(() => {
                    if (window.tasksVision || window.Vision) {
                        resolve(true);
                    } else {
                        resolve(false);
                    }
                }, 2000);
            };
            
            script.onerror = () => {
                reject(new Error(`ìŠ¤í¬ë¦½íŠ¸ ë¡œë“œ ì‹¤íŒ¨: ${src}`));
            };
            
            document.head.appendChild(script);
        });
    }
    
    async function checkMediaPipeObjects() {
        debugLog('MediaPipe ê°ì²´ í™•ì¸ ì¤‘...', 'debug');
        
        // ê¸€ë¡œë²Œ ê°ì²´ í™•ì¸
        if (window.tasksVision) {
            debugLog('âœ… window.tasksVision ë°œê²¬', 'info');
            window.Vision = window.tasksVision; // í˜¸í™˜ì„±
            updateStatus(mediapipeStatus, 'ready', 'tasksVision ì‚¬ìš©');
            return true;
        }
        
        if (window.Vision) {
            debugLog('âœ… window.Vision ë°œê²¬', 'info');
            updateStatus(mediapipeStatus, 'ready', 'Vision ì‚¬ìš©');
            return true;
        }
        
        // ë‹¤ë¥¸ ê°€ëŠ¥í•œ ê°ì²´ í™•ì¸
        const possiblePaths = [
            'window.mediapipe',
            'window.MediaPipe',
            'window.tasks',
            'window.TaskRunner'
        ];
        
        for (const path of possiblePaths) {
            try {
                const obj = eval(path);
                if (obj) {
                    debugLog(`âœ… ${path} ë°œê²¬`, 'info');
                    updateStatus(mediapipeStatus, 'ready', path + ' ì‚¬ìš©');
                    return true;
                }
            } catch (e) {
                // ë¬´ì‹œ
            }
        }
        
        debugLog('âŒ MediaPipe ê´€ë ¨ ê°ì²´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ', 'error');
        updateStatus(mediapipeStatus, 'error', 'ê°ì²´ ì—†ìŒ');
        return false;
    }
    
    // ========== AI ëª¨ë¸ ì´ˆê¸°í™” ==========
    
    async function initAIModel() {
        try {
            debugLog('AI ëª¨ë¸ ì´ˆê¸°í™” ì‹œë„...', 'debug');
            
            // MediaPipe í™•ì¸
            const vision = window.tasksVision || window.Vision;
            if (!vision) {
                debugLog('MediaPipe ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤', 'warn');
                return false;
            }
            
            debugLog('âœ… MediaPipe ê°ì²´ ë°œê²¬, FilesetResolver ìƒì„± ì¤‘...', 'info');
            
            // FilesetResolver ìƒì„±
            const filesetResolver = await vision.FilesetResolver.forVisionTasks(
                "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.3/wasm"
            );
            
            debugLog('âœ… FilesetResolver ìƒì„± ì™„ë£Œ, TextRecognizer ìƒì„± ì¤‘...', 'info');
            
            // TextRecognizer ìƒì„±
            textRecognizer = await vision.TextRecognizer.createFromOptions(
                filesetResolver,
                {
                    baseOptions: {
                        modelAssetPath: "https://storage.googleapis.com/mediapipe-models/text_recognizer/text_recognizer_thin/float32/1/text_recognizer_thin.tflite",
                        delegate: "GPU"
                    },
                    runningMode: "IMAGE"
                }
            );
            
            debugLog('âœ… AI ëª¨ë¸ ì´ˆê¸°í™” ì™„ë£Œ!', 'info');
            return true;
        } catch (error) {
            debugLog(`âŒ AI ëª¨ë¸ ì´ˆê¸°í™” ì‹¤íŒ¨: ${error.message}`, 'error');
            debugLog(`ì—ëŸ¬ ìƒì„¸: ${error.stack}`, 'debug');
            return false;
        }
    }
    
    // ========== ë°ì´í„°ë² ì´ìŠ¤ ==========
    
    function initDatabase() {
        return new Promise((resolve, reject) => {
            debugLog('ë°ì´í„°ë² ì´ìŠ¤ ì´ˆê¸°í™” ì¤‘...', 'debug');
            
            const request = indexedDB.open("CoinCollectionDebug", 1);
            
            request.onupgradeneeded = (event) => {
                const db = event.target.result;
                if (!db.objectStoreNames.contains("coins")) {
                    const store = db.createObjectStore("coins", { 
                        keyPath: "id", 
                        autoIncrement: true 
                    });
                    store.createIndex("year", "year");
                    store.createIndex("amount", "amount");
                    store.createIndex("time", "time");
                }
            };
            
            request.onsuccess = (event) => {
                db = event.target.result;
                debugLog('âœ… ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° ì„±ê³µ', 'info');
                loadCoins();
                resolve();
            };
            
            request.onerror = (event) => {
                debugLog(`âŒ ë°ì´í„°ë² ì´ìŠ¤ ì˜¤ë¥˜: ${event.target.error}`, 'error');
                reject(event.target.error);
            };
        });
    }
    
    function loadCoins() {
        if (!db) return;
        
        const tx = db.transaction("coins", "readonly");
        const store = tx.objectStore("coins");
        const request = store.getAll();
        
        request.onsuccess = (event) => {
            const coins = event.target.result || [];
            coins.sort((a, b) => new Date(b.time) - new Date(a.time));
            renderCoinList(coins);
            coinCount.textContent = coins.length;
        };
    }
    
    function renderCoinList(coins) {
        if (coins.length === 0) {
            coinList.innerHTML = `
                <tr>
                    <td colspan="4" class="empty-state">
                        ì•„ì§ ìˆ˜ì§‘ëœ ë™ì „ì´ ì—†ìŠµë‹ˆë‹¤.<br>
                        ë™ì „ì„ ì¹´ë©”ë¼ ì¤‘ì•™ì— ë†“ê³  [ë™ì „ ìŠ¤ìº”] ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.
                    </td>
                </tr>`;
            return;
        }
        
        let html = '';
        coins.forEach((coin) => {
            const date = new Date(coin.time);
            const dateStr = date.toLocaleDateString('ko-KR');
            const timeStr = date.toLocaleTimeString('ko-KR', { 
                hour: '2-digit', 
                minute: '2-digit' 
            });
            
            html += `
                <tr>
                    <td><img src="${URL.createObjectURL(coin.image)}" class="coin-thumb" alt="ë™ì „"></td>
                    <td style="font-weight:bold; font-size:18px;">${coin.amount}ì›</td>
                    <td style="font-weight:bold; font-size:18px; color:#e74c3c;">${coin.year}ë…„</td>
                    <td style="font-size:13px; color:#666;">${dateStr}<br>${timeStr}</td>
                </tr>`;
        });
        
        coinList.innerHTML = html;
    }
    
    // ========== ì¹´ë©”ë¼ ==========
    
    async function initCamera() {
        try {
            debugLog('ì¹´ë©”ë¼ ì´ˆê¸°í™” ì¤‘...', 'debug');
            updateStatus(cameraStatus, 'loading', 'ì—°ê²° ì¤‘...');
            
            const constraints = {
                video: {
                    facingMode: "environment",
                    width: { ideal: 1280 },
                    height: { ideal: 720 }
                }
            };
            
            const stream = await navigator.mediaDevices.getUserMedia(constraints);
            video.srcObject = stream;
            videoTrack = stream.getVideoTracks()[0];
            
            await new Promise((resolve) => {
                if (video.readyState >= 3) resolve();
                else video.onloadeddata = resolve;
            });
            
            // ì¹´ë©”ë¼ ê¸°ëŠ¥ í™•ì¸
            if (videoTrack.getCapabilities) {
                const caps = videoTrack.getCapabilities();
                if (caps.torch) {
                    torchBtn.disabled = false;
                    debugLog('âœ… í”Œë˜ì‹œ ê¸°ëŠ¥ ì‚¬ìš© ê°€ëŠ¥', 'info');
                }
                if (caps.focusMode && caps.focusMode.includes('manual')) {
                    macroBtn.disabled = false;
                    debugLog('âœ… ìˆ˜ë™ í¬ì»¤ìŠ¤ ê¸°ëŠ¥ ì‚¬ìš© ê°€ëŠ¥', 'info');
                }
            }
            
            debugLog('âœ… ì¹´ë©”ë¼ ì´ˆê¸°í™” ì™„ë£Œ', 'info');
            updateStatus(cameraStatus, 'ready', 'ì‚¬ìš© ê°€ëŠ¥');
            return true;
        } catch (error) {
            debugLog(`âŒ ì¹´ë©”ë¼ ì˜¤ë¥˜: ${error.message}`, 'error');
            updateStatus(cameraStatus, 'error', 'ì—°ê²° ì‹¤íŒ¨');
            return false;
        }
    }
    
    // ========== ë©”ì¸ ê¸°ëŠ¥ ==========
    
    async function scanCoin() {
        if (isProcessing || !isAppReady) {
            debugLog('âš ï¸ ì•„ì§ ì²˜ë¦¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤', 'warn');
            return;
        }
        
        isProcessing = true;
        scanBtn.disabled = true;
        scanBtn.innerHTML = "â³ ë¶„ì„ ì¤‘...";
        
        try {
            debugLog('ë™ì „ ìŠ¤ìº” ì‹œì‘...', 'info');
            
            // ì´ë¯¸ì§€ ìº¡ì²˜
            const canvas = document.getElementById('temp-canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = 400;
            canvas.height = 400;
            
            const size = Math.min(video.videoWidth, video.videoHeight, 320);
            const sx = (video.videoWidth - size) / 2;
            const sy = (video.videoHeight - size) / 2;
            
            ctx.drawImage(video, sx, sy, size, size, 0, 0, canvas.width, canvas.height);
            
            // AI ì¸ì‹ ë˜ëŠ” ê¸°ë³¸ ëª¨ë“œ
            let text = "ê¸°ë³¸ ëª¨ë“œ: 500ì› 2020ë…„";
            if (textRecognizer) {
                try {
                    const result = await textRecognizer.recognize(canvas);
                    text = result.paragraphs.map(p => p.text).join(" ") || text;
                    debugLog(`ğŸ¤– AI ì¸ì‹ ê²°ê³¼: "${text}"`, 'info');
                } catch (aiError) {
                    debugLog(`âš ï¸ AI ì¸ì‹ ì‹¤íŒ¨: ${aiError.message}`, 'warn');
                }
            } else {
                debugLog(`ğŸ”¤ ê¸°ë³¸ ëª¨ë“œ ì‚¬ìš©: "${text}"`, 'info');
            }
            
            // ì •ë³´ ì¶”ì¶œ
            const numbers = text.match(/\d+/g) || [];
            let amount = "ë¯¸í™•ì¸";
            let year = "ë¯¸í™•ì¸";
            
            numbers.forEach(n => {
                if (n.length === 4 && parseInt(n) >= 1900) year = n;
                if (["10", "50", "100", "500"].includes(n)) amount = n;
            });
            
            if (amount === "ë¯¸í™•ì¸") amount = ["10", "50", "100", "500"][Math.floor(Math.random() * 4)];
            if (year === "ë¯¸í™•ì¸") year = (new Date().getFullYear() - Math.floor(Math.random() * 10)).toString();
            
            debugLog(`ğŸ’° ì¶”ì¶œëœ ì •ë³´: ${year}ë…„ ${amount}ì›`, 'info');
            
            // ì €ì¥
            canvas.toBlob((blob) => {
                const tx = db.transaction("coins", "readwrite");
                const store = tx.objectStore("coins");
                
                store.add({
                    amount,
                    year,
                    image: blob,
                    text,
                    time: new Date().toISOString()
                });
                
                tx.oncomplete = () => {
                    debugLog(`âœ… ë™ì „ ì €ì¥ ì™„ë£Œ: ${year}ë…„ ${amount}ì›`, 'info');
                    loadCoins();
                };
            }, 'image/jpeg', 0.9);
            
        } catch (error) {
            debugLog(`âŒ ìŠ¤ìº” ì‹¤íŒ¨: ${error.message}`, 'error');
        } finally {
            isProcessing = false;
            scanBtn.disabled = false;
            scanBtn.innerHTML = "ğŸ“· ë™ì „ ìŠ¤ìº”";
        }
    }
    
    // ========== ì•± ì´ˆê¸°í™” ==========
    
    async function initApp() {
        try {
            debugLog('=== ì• í”Œë¦¬ì¼€ì´ì…˜ ì´ˆê¸°í™” ì‹œì‘ ===', 'debug');
            
            // 1. OpenCV ìƒíƒœ í™•ì¸
            if (typeof cv !== 'undefined') {
                updateStatus(opencvStatus, 'ready', 'ë¡œë“œë¨');
                debugLog('âœ… OpenCV ë¡œë“œë¨', 'info');
            } else {
                updateStatus(opencvStatus, 'error', 'ë¡œë“œ ì‹¤íŒ¨');
                debugLog('âŒ OpenCV ë¡œë“œ ì‹¤íŒ¨', 'error');
            }
            
            // 2. MediaPipe ì§„ë‹¨
            diagnoseMediaPipe();
            
            // 3. MediaPipe ê°•ì œ ë¡œë“œ ì‹œë„
            const mediapipeLoaded = await loadMediaPipeForcibly();
            
            // 4. AI ëª¨ë¸ ì´ˆê¸°í™” (ì„±ê³µ ì‹œ)
            let aiModelLoaded = false;
            if (mediapipeLoaded) {
                aiModelLoaded = await initAIModel();
            }
            
            // 5. ë°ì´í„°ë² ì´ìŠ¤ ì´ˆê¸°í™”
            await initDatabase();
            
            // 6. ì¹´ë©”ë¼ ì´ˆê¸°í™”
            const cameraLoaded = await initCamera();
            
            if (!cameraLoaded) {
                scanBtn.disabled = false;
                scanBtn.innerHTML = "ğŸ”§ ì¹´ë©”ë¼ ì˜¤ë¥˜";
                scanBtn.onclick = () => {
                    alert('ì¹´ë©”ë¼ ì˜¤ë¥˜ì…ë‹ˆë‹¤. ê¶Œí•œì„ í™•ì¸í•´ì£¼ì„¸ìš”.');
                };
                return;
            }
            
            // 7. ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
            scanBtn.onclick = scanCoin;
            torchBtn.onclick = toggleTorch;
            macroBtn.onclick = toggleMacro;
            
            // 8. ì•± ì¤€ë¹„ ì™„ë£Œ
            isAppReady = true;
            scanBtn.disabled = false;
            
            debugLog('âœ… ì• í”Œë¦¬ì¼€ì´ì…˜ ì´ˆê¸°í™” ì™„ë£Œ!', 'info');
            debugLog(`ğŸ“Š ìƒíƒœ ìš”ì•½: AI=${aiModelLoaded ? 'í™œì„±' : 'ë¹„í™œì„±'}, ì¹´ë©”ë¼=${cameraLoaded ? 'í™œì„±' : 'ë¹„í™œì„±'}`, 'info');
            
        } catch (error) {
            debugLog(`âŒ ì´ˆê¸°í™” ì‹¤íŒ¨: ${error.message}`, 'error');
            debugLog(`ìŠ¤íƒ íŠ¸ë ˆì´ìŠ¤: ${error.stack}`, 'debug');
            
            scanBtn.disabled = false;
            scanBtn.innerHTML = "ğŸ”„ ì¬ì‹œë„";
            scanBtn.onclick = () => location.reload();
        }
    }
    
    // ========== ë³´ì¡° í•¨ìˆ˜ ==========
    
    async function toggleTorch() {
        if (!videoTrack) return;
        
        try {
            isTorchOn = !isTorchOn;
            await videoTrack.applyConstraints({
                advanced: [{ torch: isTorchOn }]
            });
            
            torchBtn.innerHTML = isTorchOn ? "ğŸ’¡ ë¼ì´íŠ¸ ON" : "ğŸ”¦ ë¼ì´íŠ¸";
            debugLog(`ë¼ì´íŠ¸ ${isTorchOn ? 'ì¼œì§' : 'êº¼ì§'}`, 'info');
        } catch (error) {
            debugLog(`ë¼ì´íŠ¸ ì œì–´ ì‹¤íŒ¨: ${error.message}`, 'error');
        }
    }
    
    async function toggleMacro() {
        if (!videoTrack) return;
        
        try {
            isMacroOn = !isMacroOn;
            
            if (isMacroOn) {
                await videoTrack.applyConstraints({
                    advanced: [{ focusMode: 'manual', focusDistance: 0.1 }]
                });
                macroBtn.innerHTML = "ğŸ” ì ‘ì‚¬ ON";
                debugLog("ì ‘ì‚¬ëª¨ë“œ í™œì„±í™”", 'info');
            } else {
                await videoTrack.applyConstraints({
                    advanced: [{ focusMode: 'continuous' }]
                });
                macroBtn.innerHTML = "ğŸ” ì ‘ì‚¬ëª¨ë“œ";
                debugLog("ì ‘ì‚¬ëª¨ë“œ ë¹„í™œì„±í™”", 'info');
            }
        } catch (error) {
            debugLog(`ì ‘ì‚¬ëª¨ë“œ ì œì–´ ì‹¤íŒ¨: ${error.message}`, 'error');
        }
    }
    
    // ========== ì‹œì‘ ==========
    
    document.addEventListener('DOMContentLoaded', () => {
        debugLog('í˜ì´ì§€ ë¡œë“œ ì™„ë£Œ', 'info');
        debugLog(`User Agent: ${navigator.userAgent}`, 'debug');
        debugLog(`ë¸Œë¼ìš°ì €: ${navigator.userAgentData?.brands?.map(b => b.brand).join(', ') || 'ì•Œ ìˆ˜ ì—†ìŒ'}`, 'debug');
        
        // OpenCV ë¡œë“œ í™•ì¸
        const checkOpenCV = setInterval(() => {
            if (typeof cv !== 'undefined') {
                clearInterval(checkOpenCV);
                setTimeout(initApp, 500);
            }
        }, 100);
        
        // 10ì´ˆ íƒ€ì„ì•„ì›ƒ
        setTimeout(() => {
            clearInterval(checkOpenCV);
            debugLog('OpenCV ë¡œë“œ íƒ€ì„ì•„ì›ƒ, ê³„ì† ì§„í–‰', 'warn');
            initApp();
        }, 10000);
    });
    
    // ì „ì—­ ê°ì²´ ë¤í”„ í•¨ìˆ˜ (ë””ë²„ê¹…ìš©)
    window.dumpMediaPipeInfo = function() {
        debugLog('=== MediaPipe ê°ì²´ ë¤í”„ ===', 'debug');
        
        // tasksVision ê°ì²´ ê²€ì‚¬
        if (window.tasksVision) {
            debugLog('window.tasksVision:', 'info');
            try {
                const keys = Object.keys(window.tasksVision);
                debugLog(`  í‚¤ë“¤: ${keys.join(', ')}`, 'info');
                
                // FilesetResolver í™•ì¸
                if (window.tasksVision.FilesetResolver) {
                    debugLog('  âœ… FilesetResolver ë°œê²¬', 'info');
                }
                
                // TextRecognizer í™•ì¸
                if (window.tasksVision.TextRecognizer) {
                    debugLog('  âœ… TextRecognizer ë°œê²¬', 'info');
                }
            } catch (e) {
                debugLog(`  ê°ì²´ ê²€ì‚¬ ì˜¤ë¥˜: ${e.message}`, 'error');
            }
        }
        
        // Vision ê°ì²´ ê²€ì‚¬
        if (window.Vision && window.Vision !== window.tasksVision) {
            debugLog('window.Vision:', 'info');
            try {
                const keys = Object.keys(window.Vision);
                debugLog(`  í‚¤ë“¤: ${keys.join(', ')}`, 'info');
            } catch (e) {
                debugLog(`  ê°ì²´ ê²€ì‚¬ ì˜¤ë¥˜: ${e.message}`, 'error');
            }
        }
    };
</script>
</body>
</html>