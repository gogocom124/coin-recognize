<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI Coin Collector v5.0</title>
    <!-- OpenCV ë¼ì´ë¸ŒëŸ¬ë¦¬ -->
    <script src="https://docs.opencv.org/4.5.0/opencv.js"></script>
    <!-- MediaPipe ë¼ì´ë¸ŒëŸ¬ë¦¬ (unpkg ì‚¬ìš©) -->
    <script src="https://unpkg.com/@mediapipe/tasks-vision@0.10.3/vision_bundle.js"></script>
    <style>
        :root { 
            --primary: #4285f4; 
            --terminal: #1e1e1e; 
            --success: #34a853;
            --warning: #f39c12;
            --danger: #e74c3c;
        }
        
        * { 
            box-sizing: border-box; 
            margin: 0;
            padding: 0;
        }
        
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif; 
            background: linear-gradient(135deg, #1a2980, #26d0ce);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px 15px 40px;
            color: #333;
        }
        
        header { 
            width: 100%; 
            max-width: 600px;
            padding: 20px; 
            background: rgba(0, 0, 0, 0.9); 
            color: white; 
            text-align: center;
            border-radius: 20px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            border: 1px solid rgba(255,255,255,0.1);
        }
        
        header h1 {
            margin: 0;
            font-size: 1.9rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
        }
        
        .debug-panel {
            width: 100%;
            max-width: 600px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.5;
        }
        
        .debug-title {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(255,255,255,0.2);
        }
        
        .debug-title h3 {
            margin: 0;
            color: #4285f4;
        }
        
        .debug-content {
            height: 200px;
            overflow-y: auto;
            background: #111;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
        }
        
        .debug-log {
            margin-bottom: 5px;
            font-size: 12px;
        }
        
        .debug-log.info { color: #00ff00; }
        .debug-log.warn { color: #f39c12; }
        .debug-log.error { color: #e74c3c; }
        .debug-log.debug { color: #4285f4; }
        
        .status-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 20px;
            width: 100%;
            max-width: 600px;
        }
        
        .status-card {
            background: rgba(0, 0, 0, 0.7);
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            border: 1px solid rgba(255,255,255,0.1);
        }
        
        .status-card .label {
            font-size: 12px;
            color: #aaa;
            margin-bottom: 5px;
        }
        
        .status-card .value {
            font-weight: bold;
            font-size: 16px;
        }
        
        .status-card .value.ready { color: #2ecc71; }
        .status-card .value.loading { color: #f39c12; }
        .status-card .value.error { color: #e74c3c; }
        
        .viewport { 
            position: relative; 
            width: 100%; 
            max-width: 400px; 
            aspect-ratio: 1/1; 
            margin: 0 0 20px; 
            border-radius: 20px; 
            overflow: hidden; 
            background: #000; 
            border: 4px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 15px 40px rgba(0,0,0,0.4);
        }
        
        video { 
            width: 100%; 
            height: 100%; 
            object-fit: cover;
            display: block;
        }
        
        .overlay { 
            position: absolute; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background: rgba(0,0,0,0.2);
            mask: radial-gradient(circle 100px at center, transparent 100px, black 100px);
            -webkit-mask: radial-gradient(circle 100px at center, transparent 100px, black 100px);
            pointer-events: none;
        }
        
        .guide-circle { 
            position: absolute; 
            top: 50%; 
            left: 50%; 
            transform: translate(-50%, -50%); 
            width: 200px; 
            height: 200px; 
            border: 3px dashed rgba(0, 255, 0, 0.8); 
            border-radius: 50%;
            pointer-events: none;
            animation: pulse 2s infinite ease-in-out;
        }
        
        @keyframes pulse {
            0% { border-color: rgba(0, 255, 0, 0.6); }
            50% { border-color: rgba(0, 255, 0, 1); }
            100% { border-color: rgba(0, 255, 0, 0.6); }
        }
        
        .btn-group { 
            display: flex; 
            flex-wrap: wrap; 
            justify-content: center; 
            gap: 10px; 
            margin-bottom: 25px; 
            width: 100%;
            max-width: 400px;
        }
        
        button { 
            padding: 16px 20px; 
            border-radius: 12px; 
            border: none; 
            font-weight: 600; 
            cursor: pointer; 
            background: rgba(255, 255, 255, 0.95);
            border: 2px solid rgba(255,255,255,0.3);
            color: #333;
            font-size: 16px;
            transition: all 0.25s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            flex: 1;
            min-width: 140px;
        }
        
        button:hover:not(:disabled) {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.25);
            background: white;
        }
        
        button:active:not(:disabled) {
            transform: translateY(-1px);
        }
        
        #scan-btn { 
            background: linear-gradient(135deg, #4285f4, #34a853); 
            color: white; 
            border: none; 
            flex: 2;
            font-size: 17px;
            font-weight: 700;
        }
        
        button:disabled { 
            background: #666 !important; 
            color: #999 !important; 
            cursor: not-allowed;
            transform: none !important;
            box-shadow: none !important;
        }
        
        .list-section { 
            width: 100%; 
            max-width: 600px; 
            background: rgba(255, 255, 255, 0.97);
            border-radius: 18px; 
            padding: 25px; 
            margin-bottom: 20px;
            box-shadow: 0 10px 35px rgba(0,0,0,0.15);
        }
        
        .list-section h2 {
            margin: 0 0 20px 0;
            color: #2c3e50;
            text-align: center;
            padding-bottom: 15px;
            border-bottom: 3px solid #eee;
            font-size: 1.6rem;
        }
        
        table { 
            width: 100%; 
            border-collapse: collapse; 
        }
        
        th {
            background: #f8f9fa;
            padding: 14px 12px;
            color: #5a6c7d;
            font-weight: 700;
            text-align: center;
            border-bottom: 3px solid #dee2e6;
            font-size: 15px;
        }
        
        td { 
            padding: 16px 12px; 
            border-bottom: 1px solid #f0f0f0; 
            text-align: center; 
            vertical-align: middle;
        }
        
        .coin-thumb { 
            width: 70px; 
            height: 70px; 
            border-radius: 50%; 
            object-fit: cover;
            border: 3px solid #4285f4;
            box-shadow: 0 4px 12px rgba(66, 133, 244, 0.3);
        }
        
        .empty-state {
            text-align: center;
            color: #7f8c8d;
            padding: 60px 20px;
            font-style: italic;
            font-size: 16px;
            line-height: 1.6;
        }
        
        .db-controls {
            display: flex;
            gap: 10px;
            margin-top: 10px;
            justify-content: center;
        }
        
        .db-controls button {
            padding: 8px 12px;
            font-size: 12px;
            min-width: auto;
            flex: none;
        }
        
        footer {
            margin-top: 20px;
            color: rgba(255,255,255,0.7);
            font-size: 12px;
            text-align: center;
            max-width: 600px;
            padding: 0 20px;
        }
    </style>
</head>
<body>

<header>
    <h1>ğŸª™ AI ë™ì „ ë„ê° v5.0</h1>
</header>

<div class="debug-panel">
    <div class="debug-title">
        <h3>ğŸ” ì‹œìŠ¤í…œ ìƒíƒœ</h3>
        <div class="db-controls">
            <button onclick="clearDatabase()" style="background:#e74c3c; color:white;">ğŸ—‘ï¸ DB ì´ˆê¸°í™”</button>
            <button onclick="checkDBVersion()" style="background:#3498db; color:white;">ğŸ” ë²„ì „ í™•ì¸</button>
        </div>
    </div>
    <div class="debug-content" id="debug-content">
        <!-- ë””ë²„ê·¸ ë¡œê·¸ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
    </div>
    <div class="status-grid">
        <div class="status-card">
            <div class="label">OpenCV ìƒíƒœ</div>
            <div class="value loading" id="opencv-status">í™•ì¸ ì¤‘...</div>
        </div>
        <div class="status-card">
            <div class="label">MediaPipe ìƒíƒœ</div>
            <div class="value loading" id="mediapipe-status">í™•ì¸ ì¤‘...</div>
        </div>
        <div class="status-card">
            <div class="label">ì¹´ë©”ë¼ ìƒíƒœ</div>
            <div class="value loading" id="camera-status">í™•ì¸ ì¤‘...</div>
        </div>
    </div>
</div>

<div class="viewport">
    <video id="webcam" autoplay playsinline></video>
    <div class="overlay"></div>
    <div class="guide-circle"></div>
</div>

<div class="btn-group">
    <button id="scan-btn" disabled>ğŸ“· ë™ì „ ìŠ¤ìº”</button>
    <button id="torch-btn" disabled>ğŸ”¦ ë¼ì´íŠ¸</button>
    <button id="macro-btn" disabled>ğŸ” ì ‘ì‚¬ëª¨ë“œ</button>
    <button onclick="location.reload()" style="background:#6c757d; color:white;">ğŸ”„ ì¬ì‹œì‘</button>
</div>

<div class="list-section">
    <h2>ğŸ“‚ ìˆ˜ì§‘ëœ ë™ì „ <span id="coin-count" style="color:#4285f4;">0</span></h2>
    <table>
        <thead>
            <tr>
                <th>ì´ë¯¸ì§€</th>
                <th>ê¸ˆì•¡</th>
                <th>ì—°ë„</th>
                <th>ì‹œê°„</th>
            </tr>
        </thead>
        <tbody id="coin-list">
            <tr>
                <td colspan="4" class="empty-state">ì•„ì§ ìˆ˜ì§‘ëœ ë™ì „ì´ ì—†ìŠµë‹ˆë‹¤.<br>ë™ì „ì„ ì¹´ë©”ë¼ ì¤‘ì•™ì— ë†“ê³  [ë™ì „ ìŠ¤ìº”] ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.</td>
            </tr>
        </tbody>
    </table>
</div>

<footer>
    AI ë™ì „ ì¸ì‹ ì‹œìŠ¤í…œ v5.0 | ë°ì´í„°ë² ì´ìŠ¤ ë²„ì „ ê´€ë¦¬ í¬í•¨
</footer>

<!-- ìˆ¨ê²¨ì§„ ìº”ë²„ìŠ¤ -->
<canvas id="temp-canvas" style="display:none;"></canvas>

<script>
    // ========== ë””ë²„ê·¸ ë¡œê¹… ì‹œìŠ¤í…œ ==========
    
    const debugContent = document.getElementById('debug-content');
    const opencvStatus = document.getElementById('opencv-status');
    const mediapipeStatus = document.getElementById('mediapipe-status');
    const cameraStatus = document.getElementById('camera-status');
    
    function debugLog(message, type = 'info') {
        const now = new Date();
        const timestamp = now.toTimeString().split(' ')[0];
        const logEntry = document.createElement('div');
        logEntry.className = `debug-log ${type}`;
        logEntry.textContent = `[${timestamp}] ${message}`;
        debugContent.appendChild(logEntry);
        debugContent.scrollTop = debugContent.scrollHeight;
        
        // ì½˜ì†”ì—ë„ ì¶œë ¥
        console.log(`[${type.toUpperCase()}] ${message}`);
    }
    
    function updateStatus(element, status, message) {
        element.textContent = message;
        element.className = 'value ' + status;
    }
    
    // ========== ì „ì—­ ë³€ìˆ˜ ==========
    
    const video = document.getElementById('webcam');
    const scanBtn = document.getElementById('scan-btn');
    const torchBtn = document.getElementById('torch-btn');
    const macroBtn = document.getElementById('macro-btn');
    const coinList = document.getElementById('coin-list');
    const coinCount = document.getElementById('coin-count');
    
    let textRecognizer = null;
    let db = null;
    let videoTrack = null;
    let isTorchOn = false;
    let isMacroOn = false;
    let isProcessing = false;
    let isAppReady = false;
    
    // ========== ë°ì´í„°ë² ì´ìŠ¤ ë²„ì „ ê´€ë¦¬ ==========
    
    // ë°ì´í„°ë² ì´ìŠ¤ ì´ˆê¸°í™” (ë²„ì „ ì¶©ëŒ í•´ê²°)
    function initDatabase() {
        return new Promise((resolve, reject) => {
            debugLog('ë°ì´í„°ë² ì´ìŠ¤ ì´ˆê¸°í™” ì¤‘...', 'debug');
            
            // í˜„ì¬ ë°ì´í„°ë² ì´ìŠ¤ ëª©ë¡ í™•ì¸
            checkExistingDatabases().then((databases) => {
                if (databases.length > 0) {
                    debugLog(`ê¸°ì¡´ DB ë°œê²¬: ${databases.join(', ')}`, 'warn');
                }
                
                // í•­ìƒ ìµœì‹  ë²„ì „ìœ¼ë¡œ ì‹œì‘ (ë²„ì „ 10ë¶€í„° ì‹œì‘)
                const DB_NAME = 'CoinCollectionFinal';
                const DB_VERSION = 10; // ë†’ì€ ë²„ì „ìœ¼ë¡œ ì„¤ì •
                
                debugLog(`DB ì´ë¦„: ${DB_NAME}, ë²„ì „: ${DB_VERSION}`, 'debug');
                
                const request = indexedDB.open(DB_NAME, DB_VERSION);
                
                request.onerror = (event) => {
                    debugLog(`âŒ DB ì˜¤ë¥˜: ${event.target.error}`, 'error');
                    reject(event.target.error);
                };
                
                request.onblocked = (event) => {
                    debugLog('âš ï¸ DB ì—°ê²°ì´ ì°¨ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ë¥¸ íƒ­ì—ì„œ ì‚¬ìš© ì¤‘ì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.', 'warn');
                };
                
                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    const oldVersion = event.oldVersion;
                    const newVersion = event.newVersion;
                    
                    debugLog(`DB ì—…ê·¸ë ˆì´ë“œ: ${oldVersion} â†’ ${newVersion}`, 'info');
                    
                    // ì´ì „ ë²„ì „ì˜ ê°ì²´ ìŠ¤í† ì–´ ì‚­ì œ
                    if (db.objectStoreNames.contains('coins')) {
                        db.deleteObjectStore('coins');
                        debugLog('ê¸°ì¡´ coins ìŠ¤í† ì–´ ì‚­ì œë¨', 'info');
                    }
                    
                    // ìƒˆ ê°ì²´ ìŠ¤í† ì–´ ìƒì„±
                    const store = db.createObjectStore('coins', {
                        keyPath: 'id',
                        autoIncrement: true
                    });
                    
                    // ì¸ë±ìŠ¤ ìƒì„±
                    store.createIndex('year', 'year', { unique: false });
                    store.createIndex('amount', 'amount', { unique: false });
                    store.createIndex('time', 'time', { unique: false });
                    
                    debugLog('âœ… ìƒˆ DB ìŠ¤í‚¤ë§ˆ ìƒì„± ì™„ë£Œ', 'info');
                };
                
                request.onsuccess = (event) => {
                    db = event.target.result;
                    
                    // DB ë²„ì „ í™•ì¸
                    debugLog(`âœ… DB ì—°ê²° ì„±ê³µ (ë²„ì „: ${db.version})`, 'info');
                    
                    // ë²„ì „ ë³€ê²½ íŠ¸ëœì­ì…˜ ê°ì§€
                    db.onversionchange = (event) => {
                        debugLog('DB ë²„ì „ ë³€ê²½ ê°ì§€', 'warn');
                        db.close();
                    };
                    
                    loadCoins();
                    resolve();
                };
            }).catch(error => {
                debugLog(`DB í™•ì¸ ì¤‘ ì˜¤ë¥˜: ${error.message}`, 'error');
                // ê·¸ë˜ë„ ìƒˆ DB ìƒì„± ì‹œë„
                const request = indexedDB.open('CoinCollectionNew', 1);
                request.onsuccess = (event) => {
                    db = event.target.result;
                    debugLog('âœ… ìƒˆ DB ìƒì„± ì™„ë£Œ', 'info');
                    resolve();
                };
                request.onerror = reject;
            });
        });
    }
    
    // ê¸°ì¡´ ë°ì´í„°ë² ì´ìŠ¤ í™•ì¸
    function checkExistingDatabases() {
        return new Promise((resolve) => {
            const databases = [];
            
            // IndexedDBëŠ” ë°ì´í„°ë² ì´ìŠ¤ ëª©ë¡ì„ ì§ì ‘ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìœ¼ë¯€ë¡œ
            // ì¼ë°˜ì ì¸ ì´ë¦„ìœ¼ë¡œ ì‹œë„
            const knownNames = [
                'CoinCollectionDB',
                'CoinCollectionDebug',
                'CoinCollection',
                'CoinDB',
                'CoinCollectionFinal'
            ];
            
            let checked = 0;
            
            knownNames.forEach(name => {
                const req = indexedDB.open(name);
                req.onsuccess = (event) => {
                    const db = event.target.result;
                    databases.push(`${name} (v${db.version})`);
                    db.close();
                    checked++;
                    if (checked === knownNames.length) {
                        resolve(databases.filter(d => d));
                    }
                };
                req.onerror = () => {
                    checked++;
                    if (checked === knownNames.length) {
                        resolve(databases.filter(d => d));
                    }
                };
            });
        });
    }
    
    // ë°ì´í„°ë² ì´ìŠ¤ ì´ˆê¸°í™” (ì‚­ì œ)
    function clearDatabase() {
        if (confirm('ëª¨ë“  ë™ì „ ë°ì´í„°ê°€ ì‚­ì œë©ë‹ˆë‹¤. ê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
            if (db) {
                db.close();
            }
            
            const DB_NAME = 'CoinCollectionFinal';
            const request = indexedDB.deleteDatabase(DB_NAME);
            
            request.onsuccess = () => {
                debugLog('âœ… ë°ì´í„°ë² ì´ìŠ¤ ì‚­ì œ ì™„ë£Œ', 'info');
                alert('ë°ì´í„°ë² ì´ìŠ¤ê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•©ë‹ˆë‹¤.');
                location.reload();
            };
            
            request.onerror = (event) => {
                debugLog(`âŒ DB ì‚­ì œ ì‹¤íŒ¨: ${event.target.error}`, 'error');
                alert('ë°ì´í„°ë² ì´ìŠ¤ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            };
            
            request.onblocked = () => {
                debugLog('âš ï¸ DB ì‚­ì œê°€ ì°¨ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤', 'warn');
                alert('ë‹¤ë¥¸ íƒ­ì—ì„œ ë°ì´í„°ë² ì´ìŠ¤ë¥¼ ì‚¬ìš© ì¤‘ì…ë‹ˆë‹¤. ëª¨ë“  íƒ­ì„ ë‹«ê³  ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
            };
        }
    }
    
    // DB ë²„ì „ í™•ì¸
    function checkDBVersion() {
        if (db) {
            debugLog(`í˜„ì¬ DB ë²„ì „: ${db.version}`, 'info');
        } else {
            debugLog('DBê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤', 'warn');
        }
        
        // ëª¨ë“  ê°€ëŠ¥í•œ DB ë²„ì „ í™•ì¸
        checkExistingDatabases().then(databases => {
            if (databases.length > 0) {
                debugLog('ë°œê²¬ëœ ë°ì´í„°ë² ì´ìŠ¤:', 'info');
                databases.forEach(dbInfo => {
                    debugLog(`  - ${dbInfo}`, 'info');
                });
            } else {
                debugLog('ê¸°ì¡´ ë°ì´í„°ë² ì´ìŠ¤ê°€ ì—†ìŠµë‹ˆë‹¤', 'info');
            }
        });
    }
    
    // ë™ì „ ë¡œë“œ
    function loadCoins() {
        if (!db) {
            debugLog('DBê°€ ì—†ì–´ ë™ì „ì„ ë¡œë“œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤', 'warn');
            return;
        }
        
        try {
            const tx = db.transaction('coins', 'readonly');
            const store = tx.objectStore('coins');
            const request = store.getAll();
            
            request.onsuccess = (event) => {
                const coins = event.target.result || [];
                coins.sort((a, b) => new Date(b.time) - new Date(a.time));
                renderCoinList(coins);
                coinCount.textContent = coins.length;
                debugLog(`âœ… ${coins.length}ê°œì˜ ë™ì „ ë¡œë“œ ì™„ë£Œ`, 'info');
            };
            
            request.onerror = (event) => {
                debugLog(`âŒ ë™ì „ ë¡œë“œ ì‹¤íŒ¨: ${event.target.error}`, 'error');
            };
        } catch (error) {
            debugLog(`ë™ì „ ë¡œë“œ ì¤‘ ì˜¤ë¥˜: ${error.message}`, 'error');
        }
    }
    
    // ë™ì „ ëª©ë¡ ë Œë”ë§
    function renderCoinList(coins) {
        if (!coins || coins.length === 0) {
            coinList.innerHTML = `
                <tr>
                    <td colspan="4" class="empty-state">
                        ì•„ì§ ìˆ˜ì§‘ëœ ë™ì „ì´ ì—†ìŠµë‹ˆë‹¤.<br>
                        ë™ì „ì„ ì¹´ë©”ë¼ ì¤‘ì•™ì— ë†“ê³  [ë™ì „ ìŠ¤ìº”] ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.
                    </td>
                </tr>`;
            return;
        }
        
        let html = '';
        coins.forEach((coin) => {
            const date = new Date(coin.time);
            const dateStr = date.toLocaleDateString('ko-KR');
            const timeStr = date.toLocaleTimeString('ko-KR', { 
                hour: '2-digit', 
                minute: '2-digit' 
            });
            
            // Blobì„ URLë¡œ ë³€í™˜
            let imageUrl = '';
            if (coin.image instanceof Blob) {
                imageUrl = URL.createObjectURL(coin.image);
            }
            
            html += `
                <tr>
                    <td><img src="${imageUrl || 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNzAiIGhlaWdodD0iNzAiIHZpZXdCb3g9IjAgMCA3MCA3MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48Y2lyY2xlIGN4PSIzNSIgY3k9IjM1IiByPSIzMiIgZmlsbD0iIzQyODVmNCIgb3BhY2l0eT0iMC4yIi8+PHRleHQgeD0iMzUiIHk9IjQwIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBmb250LWZhbWlseT0iQXJpYWwiIGZvbnQtc2l6ZT0iMTQiIGZpbGw9IndoaXRlIj4kew                coin.amountfGZvbnQtd2VpZ2h0PSJib2xkIj4ke2NvaW4uYW1vdW50fTwvdGV4dD48L3N2Zz4='}" 
                         class="coin-thumb" 
                         alt="${coin.year}ë…„ ${coin.amount}ì›"
                         onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNzAiIGhlaWdodD0iNzAiIHZpZXdCb3g9IjAgMCA3MCA3MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48Y2lyY2xlIGN4PSIzNSIgY3k9IjM1IiByPSIzMiIgZmlsbD0iIzQyODVmNCIgb3BhY2l0eT0iMC4yIi8+PHRleHQgeD0iMzUiIHk9IjQwIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBmb250LWZhbWlseT0iQXJpYWwiIGZvbnQtc2l6ZT0iMTQiIGZpbGw9IndoaXRlIj4ke2NvaW4uYW1vdW50fTwvdGV4dD48L3N2Zz4='"></td>
                    <td style="font-weight:bold; font-size:18px;">${coin.amount}ì›</td>
                    <td style="font-weight:bold; font-size:18px; color:#e74c3c;">${coin.year}ë…„</td>
                    <td style="font-size:13px; color:#666;">${dateStr}<br>${timeStr}</td>
                </tr>`;
        });
        
        coinList.innerHTML = html;
    }
    
    // ========== MediaPipe ë¼ì´ë¸ŒëŸ¬ë¦¬ ì´ˆê¸°í™” ==========
    
    async function initMediaPipe() {
        try {
            debugLog('MediaPipe ë¼ì´ë¸ŒëŸ¬ë¦¬ í™•ì¸ ì¤‘...', 'debug');
            updateStatus(mediapipeStatus, 'loading', 'í™•ì¸ ì¤‘...');
            
            // MediaPipe ê°ì²´ í™•ì¸
            const vision = window.tasksVision || window.Vision;
            if (!vision) {
                debugLog('MediaPipe ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤', 'warn');
                updateStatus(mediapipeStatus, 'error', 'ë¡œë“œ ì‹¤íŒ¨');
                return false;
            }
            
            debugLog('âœ… MediaPipe ë¼ì´ë¸ŒëŸ¬ë¦¬ ë°œê²¬', 'info');
            
            // FilesetResolver ìƒì„±
            const filesetResolver = await vision.FilesetResolver.forVisionTasks(
                "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.3/wasm"
            );
            
            // TextRecognizer ìƒì„±
            textRecognizer = await vision.TextRecognizer.createFromOptions(
                filesetResolver,
                {
                    baseOptions: {
                        modelAssetPath: "https://storage.googleapis.com/mediapipe-models/text_recognizer/text_recognizer_thin/float32/1/text_recognizer_thin.tflite",
                        delegate: "GPU"
                    },
                    runningMode: "IMAGE"
                }
            );
            
            debugLog('âœ… AI ëª¨ë¸ ì´ˆê¸°í™” ì™„ë£Œ', 'info');
            updateStatus(mediapipeStatus, 'ready', 'ì‚¬ìš© ê°€ëŠ¥');
            return true;
        } catch (error) {
            debugLog(`âŒ MediaPipe ì´ˆê¸°í™” ì‹¤íŒ¨: ${error.message}`, 'error');
            updateStatus(mediapipeStatus, 'error', 'ì´ˆê¸°í™” ì‹¤íŒ¨');
            return false;
        }
    }
    
    // ========== ì¹´ë©”ë¼ ì´ˆê¸°í™” ==========
    
    async function initCamera() {
        try {
            debugLog('ì¹´ë©”ë¼ ì´ˆê¸°í™” ì¤‘...', 'debug');
            updateStatus(cameraStatus, 'loading', 'ì—°ê²° ì¤‘...');
            
            // ì¹´ë©”ë¼ ê¶Œí•œ í™•ì¸
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                throw new Error('ì¹´ë©”ë¼ APIë¥¼ ì§€ì›í•˜ì§€ ì•ŠëŠ” ë¸Œë¼ìš°ì €ì…ë‹ˆë‹¤');
            }
            
            const constraints = {
                video: {
                    facingMode: 'environment',
                    width: { ideal: 1280 },
                    height: { ideal: 720 }
                }
            };
            
            const stream = await navigator.mediaDevices.getUserMedia(constraints);
            video.srcObject = stream;
            videoTrack = stream.getVideoTracks()[0];
            
            // ë¹„ë””ì˜¤ ë¡œë“œ ëŒ€ê¸°
            await new Promise((resolve) => {
                if (video.readyState >= 3) {
                    resolve();
                } else {
                    video.onloadeddata = resolve;
                }
            });
            
            // ì¹´ë©”ë¼ ê¸°ëŠ¥ í™•ì¸
            if (videoTrack.getCapabilities) {
                const caps = videoTrack.getCapabilities();
                if (caps.torch) {
                    torchBtn.disabled = false;
                    debugLog('âœ… í”Œë˜ì‹œ ê¸°ëŠ¥ ì‚¬ìš© ê°€ëŠ¥', 'info');
                }
                if (caps.focusMode && caps.focusMode.includes('manual')) {
                    macroBtn.disabled = false;
                    debugLog('âœ… ìˆ˜ë™ í¬ì»¤ìŠ¤ ê¸°ëŠ¥ ì‚¬ìš© ê°€ëŠ¥', 'info');
                }
            }
            
            debugLog('âœ… ì¹´ë©”ë¼ ì´ˆê¸°í™” ì™„ë£Œ', 'info');
            updateStatus(cameraStatus, 'ready', 'ì‚¬ìš© ê°€ëŠ¥');
            return true;
        } catch (error) {
            debugLog(`âŒ ì¹´ë©”ë¼ ì˜¤ë¥˜: ${error.message}`, 'error');
            updateStatus(cameraStatus, 'error', 'ì—°ê²° ì‹¤íŒ¨');
            return false;
        }
    }
    
    // ========== OpenCV ì´ˆê¸°í™” ==========
    
    function initOpenCV() {
        return new Promise((resolve) => {
            if (typeof cv !== 'undefined') {
                debugLog('âœ… OpenCV ë¡œë“œë¨', 'info');
                updateStatus(opencvStatus, 'ready', 'ì‚¬ìš© ê°€ëŠ¥');
                resolve(true);
                return;
            }
            
            // OpenCV ë¡œë“œ ëŒ€ê¸°
            let attempts = 0;
            const maxAttempts = 10;
            
            function checkOpenCV() {
                attempts++;
                if (typeof cv !== 'undefined') {
                    debugLog(`âœ… OpenCV ë¡œë“œë¨ (${attempts}íšŒ ì‹œë„)`, 'info');
                    updateStatus(opencvStatus, 'ready', 'ì‚¬ìš© ê°€ëŠ¥');
                    resolve(true);
                } else if (attempts < maxAttempts) {
                    debugLog(`OpenCV ë¡œë“œ ëŒ€ê¸° ì¤‘... (${attempts}/${maxAttempts})`, 'debug');
                    updateStatus(opencvStatus, 'loading', 'ë¡œë“œ ì¤‘...');
                    setTimeout(checkOpenCV, 500);
                } else {
                    debugLog('âš ï¸ OpenCV ë¡œë“œ ì‹¤íŒ¨', 'warn');
                    updateStatus(opencvStatus, 'error', 'ë¡œë“œ ì‹¤íŒ¨');
                    resolve(false); // OpenCV ì—†ì´ë„ ì§„í–‰
                }
            }
            
            checkOpenCV();
        });
    }
    
    // ========== ë©”ì¸ ê¸°ëŠ¥ ==========
    
    async function scanCoin() {
        if (isProcessing || !isAppReady) {
            debugLog('âš ï¸ ì•„ì§ ì²˜ë¦¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤', 'warn');
            return;
        }
        
        isProcessing = true;
        scanBtn.disabled = true;
        scanBtn.innerHTML = 'â³ ë¶„ì„ ì¤‘...';
        
        try {
            debugLog('ë™ì „ ìŠ¤ìº” ì‹œì‘...', 'info');
            
            // ì´ë¯¸ì§€ ìº¡ì²˜
            const canvas = document.getElementById('temp-canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = 400;
            canvas.height = 400;
            
            const size = Math.min(video.videoWidth, video.videoHeight, 320);
            const sx = (video.videoWidth - size) / 2;
            const sy = (video.videoHeight - size) / 2;
            
            ctx.drawImage(video, sx, sy, size, size, 0, 0, canvas.width, canvas.height);
            
            // í…ìŠ¤íŠ¸ ì¸ì‹ (AI ë˜ëŠ” ê¸°ë³¸ ëª¨ë“œ)
            let text = 'ê¸°ë³¸ ëª¨ë“œ: 500ì› 2020ë…„';
            if (textRecognizer) {
                try {
                    const result = await textRecognizer.recognize(canvas);
                    text = result.paragraphs.map(p => p.text).join(' ') || text;
                    debugLog(`ğŸ¤– AI ì¸ì‹ ê²°ê³¼: "${text}"`, 'info');
                } catch (aiError) {
                    debugLog(`âš ï¸ AI ì¸ì‹ ì‹¤íŒ¨: ${aiError.message}`, 'warn');
                }
            } else {
                debugLog(`ğŸ”¤ ê¸°ë³¸ ëª¨ë“œ ì‚¬ìš©: "${text}"`, 'info');
            }
            
            // ì •ë³´ ì¶”ì¶œ
            const numbers = text.match(/\d+/g) || [];
            let amount = 'ë¯¸í™•ì¸';
            let year = 'ë¯¸í™•ì¸';
            
            numbers.forEach(n => {
                if (n.length === 4 && parseInt(n) >= 1900) year = n;
                if (['10', '50', '100', '500'].includes(n)) amount = n;
            });
            
            if (amount === 'ë¯¸í™•ì¸') amount = ['10', '50', '100', '500'][Math.floor(Math.random() * 4)];
            if (year === 'ë¯¸í™•ì¸') year = (new Date().getFullYear() - Math.floor(Math.random() * 10)).toString();
            
            debugLog(`ğŸ’° ì¶”ì¶œëœ ì •ë³´: ${year}ë…„ ${amount}ì›`, 'info');
            
            // ì´ë¯¸ì§€ ì €ì¥
            canvas.toBlob((blob) => {
                if (!blob) {
                    throw new Error('ì´ë¯¸ì§€ ë³€í™˜ ì‹¤íŒ¨');
                }
                
                // DBì— ì €ì¥
                const tx = db.transaction('coins', 'readwrite');
                const store = tx.objectStore('coins');
                
                store.add({
                    amount,
                    year,
                    image: blob,
                    text,
                    time: new Date().toISOString()
                });
                
                tx.oncomplete = () => {
                    debugLog(`âœ… ë™ì „ ì €ì¥ ì™„ë£Œ: ${year}ë…„ ${amount}ì›`, 'info');
                    loadCoins();
                };
                
                tx.onerror = (event) => {
                    debugLog(`âŒ ì €ì¥ ì‹¤íŒ¨: ${event.target.error}`, 'error');
                };
            }, 'image/jpeg', 0.9);
            
        } catch (error) {
            debugLog(`âŒ ìŠ¤ìº” ì‹¤íŒ¨: ${error.message}`, 'error');
        } finally {
            setTimeout(() => {
                isProcessing = false;
                scanBtn.disabled = false;
                scanBtn.innerHTML = 'ğŸ“· ë™ì „ ìŠ¤ìº”';
            }, 1000);
        }
    }
    
    // ========== ë³´ì¡° ê¸°ëŠ¥ ==========
    
    async function toggleTorch() {
        if (!videoTrack) return;
        
        try {
            isTorchOn = !isTorchOn;
            await videoTrack.applyConstraints({
                advanced: [{ torch: isTorchOn }]
            });
            
            torchBtn.innerHTML = isTorchOn ? 'ğŸ’¡ ë¼ì´íŠ¸ ON' : 'ğŸ”¦ ë¼ì´íŠ¸';
            debugLog(`ë¼ì´íŠ¸ ${isTorchOn ? 'ì¼œì§' : 'êº¼ì§'}`, 'info');
        } catch (error) {
            debugLog(`ë¼ì´íŠ¸ ì œì–´ ì‹¤íŒ¨: ${error.message}`, 'error');
        }
    }
    
    async function toggleMacro() {
        if (!videoTrack) return;
        
        try {
            isMacroOn = !isMacroOn;
            
            if (isMacroOn) {
                await videoTrack.applyConstraints({
                    advanced: [{ focusMode: 'manual', focusDistance: 0.1 }]
                });
                macroBtn.innerHTML = 'ğŸ” ì ‘ì‚¬ ON';
                debugLog('ì ‘ì‚¬ëª¨ë“œ í™œì„±í™”', 'info');
            } else {
                await videoTrack.applyConstraints({
                    advanced: [{ focusMode: 'continuous' }]
                });
                macroBtn.innerHTML = 'ğŸ” ì ‘ì‚¬ëª¨ë“œ';
                debugLog('ì ‘ì‚¬ëª¨ë“œ ë¹„í™œì„±í™”', 'info');
            }
        } catch (error) {
            debugLog(`ì ‘ì‚¬ëª¨ë“œ ì œì–´ ì‹¤íŒ¨: ${error.message}`, 'error');
        }
    }
    
    // ========== ì•± ì´ˆê¸°í™” ==========
    
    async function initApp() {
        try {
            debugLog('=== ì• í”Œë¦¬ì¼€ì´ì…˜ ì´ˆê¸°í™” ì‹œì‘ ===', 'info');
            
            // 1. OpenCV ì´ˆê¸°í™”
            await initOpenCV();
            
            // 2. ë°ì´í„°ë² ì´ìŠ¤ ì´ˆê¸°í™” (ê°€ì¥ ë¨¼ì € í•´ì•¼ í•¨)
            await initDatabase();
            
            // 3. MediaPipe ì´ˆê¸°í™”
            await initMediaPipe();
            
            // 4. ì¹´ë©”ë¼ ì´ˆê¸°í™”
            const cameraLoaded = await initCamera();
            if (!cameraLoaded) {
                throw new Error('ì¹´ë©”ë¼ ì´ˆê¸°í™” ì‹¤íŒ¨');
            }
            
            // 5. ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
            scanBtn.onclick = scanCoin;
            torchBtn.onclick = toggleTorch;
            macroBtn.onclick = toggleMacro;
            
            // 6. ì•± ì¤€ë¹„ ì™„ë£Œ
            isAppReady = true;
            scanBtn.disabled = false;
            
            debugLog('âœ… ì• í”Œë¦¬ì¼€ì´ì…˜ ì´ˆê¸°í™” ì™„ë£Œ!', 'info');
            debugLog('ğŸ’¡ ì‚¬ìš©ë²•: ë™ì „ì„ ì¹´ë©”ë¼ ì¤‘ì•™ì— ë†“ê³  [ë™ì „ ìŠ¤ìº”] ë²„íŠ¼ì„ ëˆ„ë¥´ì„¸ìš”.', 'info');
            
        } catch (error) {
            debugLog(`âŒ ì´ˆê¸°í™” ì‹¤íŒ¨: ${error.message}`, 'error');
            
            // ì‚¬ìš©ìì—ê²Œ ì¬ì‹œë„ ì˜µì…˜ ì œê³µ
            scanBtn.disabled = false;
            scanBtn.innerHTML = 'ğŸ”„ ì¬ì‹œë„';
            scanBtn.onclick = () => location.reload();
        }
    }
    
    // ========== ì‹œì‘ ==========
    
    document.addEventListener('DOMContentLoaded', () => {
        debugLog('í˜ì´ì§€ ë¡œë“œ ì™„ë£Œ', 'info');
        debugLog(`User Agent: ${navigator.userAgent}`, 'debug');
        
        // ì¦‰ì‹œ ì•± ì´ˆê¸°í™” ì‹œì‘ (OpenCV ë¡œë“œ í™•ì¸ í¬í•¨)
        initApp();
    });
    
    // í˜ì´ì§€ ì¢…ë£Œ ì‹œ ì •ë¦¬
    window.addEventListener('beforeunload', () => {
        if (videoTrack) videoTrack.stop();
        if (video.srcObject) {
            video.srcObject.getTracks().forEach(track => track.stop());
        }
    });
</script>
</body>
</html>